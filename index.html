<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト表分析ツール（最適化印刷版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon {
            color: #2563eb;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
            flex-wrap: wrap;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 64px 32px;
            text-align: center;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2563eb;
        }

        .upload-area.dragover {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            background: #eff6ff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .form-group {
            margin-bottom: 16px;
        }

        .label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .input, .select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .date-button {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
            min-width: 150px;
            text-align: center;
        }

        .date-button:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .date-button.selected {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }

        .calendar-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .calendar-popup.show {
            display: flex;
        }

        .calendar-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            animation: popup-enter 0.2s ease-out;
        }

        @keyframes popup-enter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .calendar-nav:hover {
            background: #e5e7eb;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .calendar-day.selected {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .calendar-day.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .calendar-day.weekend {
            color: #dc2626;
        }

        .calendar-day.saturday {
            color: #2563eb;
        }

        .calendar-close {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 16px;
            float: right;
        }

        .calendar-close:hover {
            background: #4b5563;
        }

        .plan-uph-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .plan-uph-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }

        .plan-uph-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            text-align: center;
        }

        .out-section {
            border-left: 4px solid #dc2626;
        }

        .in-section {
            border-left: 4px solid #059669;
        }

        .night-section {
            border-left: 4px solid #7c3aed;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .setting-label {
            font-size: 14px;
            color: #374151;
        }

        .setting-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
        }

        .analysis-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .analysis-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .analysis-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            padding: 16px 24px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .out-title {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .in-title {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .night-title {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .analysis-content {
            padding: 0;
        }

        .employee-list-container {
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid #e5e7eb;
        }

        .print-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #e5e7eb;
        }

        .print-button {
            background: #059669;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-button:hover {
            background: #047857;
        }

        .print-preview {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 210mm;
            margin-left: auto;
            margin-right: auto;
        }

        .reset-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .file-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .debug-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }

        .print-preview .print-table {
            font-size: 10px;
            margin-bottom: 8px;
        }

        .print-preview .print-table th,
        .print-preview .print-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            line-height: 1.2;
            text-align: center;
            vertical-align: middle;
        }

        .print-preview .print-stats {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 12px;
            font-size: 10px;
        }

        .print-preview .print-stat-item {
            text-align: center;
            border: 1px solid #000;
            padding: 4px;
            vertical-align: middle;
        }

        /* 最適化印刷用CSS - 行数対応版 */
        @media print {
            /* 基本設定をリセット */
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            
            html, body {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
            }
            
            /* 非印刷要素を非表示 */
            body * {
                visibility: hidden;
            }
            
            .print-content, .print-content * {
                visibility: visible;
            }
            
            /* 印刷レイアウトの最適化 */
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 0;
                margin: 0;
                background: white;
                font-size: 10px;
                line-height: 1.2;
                page-break-inside: avoid;
            }

            /* ページ設定 - A4サイズ、余白最小化 */
            @page {
                size: A4;
                margin: 8mm 6mm;
                padding: 0;
            }

            /* 印刷内容コンテナ */
            .print-day-container {
                width: 100%;
                height: auto !important;
                max-height: none !important;
                margin: 0;
                padding: 0;
                page-break-before: auto;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            /* ヘッダー部分 */
            .print-header {
                width: 100%;
                text-align: center;
                margin-bottom: 6px;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            .print-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 2px;
            }

            /* 統計情報 */
            .print-stats {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                margin-bottom: 6px;
                font-size: 9px;
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            .print-stat-item {
                text-align: center;
                border: 1px solid #000;
                padding: 2px;
                line-height: 1.1;
                vertical-align: middle;
                height: auto;
            }

            /* テーブル最適化 - 行数対応 */
            .print-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 8px;
                margin: 0;
                padding: 0;
                /* テーブル全体の高さを自動調整 */
                height: auto !important;
                max-height: none !important;
                /* 改ページを内容に応じて調整 */
                page-break-inside: auto;
                page-break-before: auto;
                page-break-after: auto;
                /* 孤立行・寡婦行の制御 */
                orphans: 2;
                widows: 2;
            }

            /* テーブルヘッダー */
            .print-table thead {
                display: table-header-group;
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            .print-table th {
                background: #f0f0f0 !important;
                font-weight: bold;
                text-align: center;
                font-size: 7px;
                border: 1px solid #000;
                padding: 1px 2px;
                /* ヘッダー高さ固定 */
                height: 16pt !important;
                min-height: 16pt !important;
                max-height: 16pt !important;
                line-height: 1.0;
                vertical-align: middle;
            }

            /* テーブル行 */
            .print-table tr {
                /* 行の分割を許可して自然な改ページ */
                page-break-inside: auto;
                page-break-after: auto;
            }

            .print-table thead tr {
                page-break-after: avoid;
            }

            /* テーブルセル - 文字サイズ固定、高さ最適化 */
            .print-table td {
                border: 1px solid #000;
                padding: 1px 2px;
                text-align: center;
                vertical-align: middle;
                line-height: 1.0;
                word-wrap: break-word;
                overflow: hidden;
                /* セル高さ固定（文字サイズに対応） */
                height: 14pt !important;
                min-height: 14pt !important;
                max-height: 14pt !important;
                font-size: 8px !important;
            }

            /* キャプション */
            .print-table-caption {
                display: table-caption;
                caption-side: top;
                page-break-inside: avoid;
                page-break-after: avoid;
                font-weight: bold;
                text-align: center;
                margin-bottom: 3px;
                font-size: 11px;
                background: #f0f0f0;
                border: 1px solid #000;
                padding: 3px;
            }

            /* フッター */
            .print-footer {
                width: 100%;
                margin-top: 4px;
                display: flex;
                justify-content: space-between;
                border-top: 1px solid #000;
                padding-top: 2px;
                font-size: 9px;
                page-break-inside: avoid;
                page-break-before: avoid;
            }

            /* 単日印刷特別設定 */
            .print-single-day {
                /* 内容に完全に合わせる */
                height: auto !important;
                min-height: auto !important;
                max-height: none !important;
                /* 自然な改ページ */
                page-break-before: auto !important;
                page-break-after: auto !important;
                page-break-inside: auto !important;
            }

            /* 複数日印刷での改ページ制御 */
            .print-multi-day .print-day-container:not(:first-child) {
                page-break-before: always;
            }

            /* 不要な空白を排除 */
            .print-content > *:last-child {
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }

            /* 空のdivやspanを非表示 */
            .print-content div:empty,
            .print-content span:empty,
            .print-content p:empty {
                display: none !important;
            }

            /* プレビューボックスの印刷時調整 */
            .print-preview {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: none !important;
            }
        }

        .summary-card {
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .out-summary {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #dc2626;
        }

        .in-summary {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #059669;
        }

        .night-summary {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-left: 4px solid #7c3aed;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .stat-blue { color: #2563eb; }
        .stat-green { color: #059669; }
        .stat-orange { color: #d97706; }
        .stat-red { color: #dc2626; }
        .stat-purple { color: #7c3aed; }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .status-section {
            margin-bottom: 24px;
        }

        .status-header {
            background: #f9fafb;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-title {
            font-weight: 600;
            color: #1f2937;
        }

        .status-info {
            font-size: 14px;
            color: #6b7280;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 18px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        .requirement-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .requirement-list h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .requirement-list ul {
            list-style: none;
            padding: 0;
        }

        .requirement-list li {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .requirement-list li::before {
            content: "•";
            color: #2563eb;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .analysis-container {
                grid-template-columns: 1fr;
            }

            .employee-list-container {
                max-height: 300px;
            }

            .calendar-content {
                width: 95%;
                padding: 16px;
            }

            .date-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .date-button {
                min-width: auto;
            }

            .plan-uph-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ファイルアップロード画面 -->
        <div id="upload-screen" class="card">
            <div style="text-align: center;">
                <div class="upload-icon">
                    <svg width="24" height="24" fill="none" stroke="#2563eb" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h1 class="title" style="justify-content: center; margin-bottom: 16px;">
                    <span class="icon">📅</span>
                    シフト表分析ツール（最適化印刷版）
                </h1>
                <p style="color: #6b7280; margin-bottom: 24px;">
                    Excelシフト表をアップロードして、OUT/IN別の日別勤務状態分析とLH調整を行います<br>
                    <strong>🖨️ 印刷最適化:</strong> 行数に応じた最適なページ数で印刷、文字サイズ固定<br>
                    <strong>📄 空白ページ排除:</strong> 不要な空白ページを完全排除、コンパクト印刷<br>
                    <strong>🌙 夜勤対応:</strong> A列の時間帯情報から夜勤を自動判定・分析<br>
                    <strong>業務自動分類:</strong> ICQA・Pick・Read等→IN系、Pack・FL・Ship等→OUT系に自動分類<br>
                    <strong>🗓️ 当日優先:</strong> 対象日選択のデフォルトは当日の日付<br>
                    <strong>📊 動的設定:</strong> 設定値は選択日に応じて自動調整
                </p>

                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                    <div class="upload-icon">
                        <svg width="24" height="24" fill="none" stroke="#2563eb" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <div style="font-size: 18px; font-weight: 500; color: #374151; margin-bottom: 4px;">
                        シフト表ファイルをアップロード
                    </div>
                    <div style="font-size: 14px; color: #6b7280;">
                        .xlsx または .xls ファイルを選択してください
                    </div>
                </div>
                
                <div class="requirement-list">
                    <h3>✅ 印刷最適化（NEW）:</h3>
                    <ul>
                        <li>🖨️ <strong>行数対応印刷:</strong> 実際のデータ行数に応じた最適なページ数</li>
                        <li>📄 <strong>空白ページ排除:</strong> 5ページ→実際の行数分のみ印刷</li>
                        <li>🎯 <strong>文字サイズ固定:</strong> 読みやすさを維持したまま最適化</li>
                        <li>📏 <strong>余白最小化:</strong> A4用紙を最大限活用</li>
                        <li>🔧 <strong>改ページ最適化:</strong> 自然な位置でのページ分割</li>
                        <li>⚡ <strong>印刷高速化:</strong> 不要な処理を削減し印刷速度向上</li>
                    </ul>
                    
                    <h3>必要なファイル形式：</h3>
                    <ul>
                        <li>1行目: OUT PLAN（J列以降）</li>
                        <li>2行目: OUT設定UPH（J列以降）</li>
                        <li>3行目: IN PLAN（J列以降）</li>
                        <li>4行目: IN設定UPH（J列以降）</li>
                        <li>5行目: 日付（K列以降）</li>
                        <li>6行目以降: 従業員データ（A-D列: 基本情報、G-J列: 時間情報、K列以降: 日別勤務状態）</li>
                    </ul>
                    
                    <h3 style="margin-top: 16px;">対応勤務状態：</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <div>
                            <strong style="color: #dc2626;">OUT系:</strong><br>
                            <span style="font-size: 12px;">Pack, FL, Bulk, Ship, Out_Fork, Out_Indirect, OUTQA など</span>
                        </div>
                        <div>
                            <strong style="color: #059669;">IN系:</strong><br>
                            <span style="font-size: 12px;">ICQA, Hi, Pick, Read, Receive, Inbound など</span>
                        </div>
                        <div>
                            <strong style="color: #7c3aed;">夜勤:</strong><br>
                            <span style="font-size: 12px;">A列の時間帯情報から自動判定（夜勤、B勤、N勤など）</span>
                        </div>
                    </div>
                </div>

                <!-- デバッグパネル -->
                <div class="debug-panel" id="debug-panel" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 8px;">デバッグログ:</div>
                    <div id="debug-log"></div>
                </div>
            </div>
        </div>

        <!-- ローディング画面 -->
        <div id="loading-screen" class="card hidden">
            <div class="loading">
                <div style="margin-bottom: 16px;">
                    <div id="loading-message">データを読み込み中...</div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 4px; margin-top: 8px;">
                        <div id="loading-progress" style="width: 0%; height: 8px; background: #2563eb; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="loading-details" style="font-size: 12px; color: #6b7280; max-height: 200px; overflow-y: auto; text-align: left; white-space: pre-line;"></div>
            </div>
        </div>

        <!-- メイン分析画面 -->
        <div id="main-screen" class="hidden">
            <div class="card">
                <div class="header">
                    <h1 class="title">
                        <span class="icon">📅</span>
                        シフト表分析（最適化印刷版）
                    </h1>
                    <div class="file-info">
                        <div>ファイル: <span id="current-filename" style="font-weight: 500;"></span></div>
                        <button class="btn btn-warning" id="force-reset-btn">
                            🔄 強制リセット
                        </button>
                        <button class="btn" onclick="document.getElementById('new-file-input').click()">
                            📁 新しいファイル
                        </button>
                        <button class="btn btn-secondary" id="toggle-debug-btn">
                            🐛 デバッグ表示
                        </button>
                        <input type="file" id="new-file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>

                <!-- ファイル状態表示 -->
                <div class="file-status" id="file-status">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-indicator status-success"></span>
                        <span id="file-status-text">ファイル読み込み完了</span>
                    </div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        最終更新: <span id="file-timestamp"></span>
                    </div>
                </div>

                <!-- 最適化情報 -->
                <div class="reset-section">
                    <h3 style="font-size: 16px; font-weight: 600; color: #059669; margin-bottom: 8px;">
                        🖨️ 印刷最適化版（NEW）
                    </h3>
                    <div style="font-size: 14px; color: #047857; line-height: 1.6;">
                        <div>📄 <strong>行数対応印刷:</strong> 実際のデータ行数に応じた最適なページ数</div>
                        <div>🎯 <strong>空白ページ排除:</strong> 不要な空白ページを完全排除</div>
                        <div>📏 <strong>文字サイズ固定:</strong> 読みやすさを維持したまま最適化</div>
                        <div>⚡ <strong>印刷高速化:</strong> 効率的な印刷処理で時間短縮</div>
                        <div>📋 <strong>A4最適化:</strong> 用紙を最大限活用したレイアウト</div>
                    </div>
                </div>

                <!-- 設定パネル -->
                <div style="margin-bottom: 24px;">
                    <!-- 日付選択 -->
                    <div style="margin-bottom: 16px;">
                        <label class="label">対象日選択</label>
                        <div class="date-selector">
                            <button class="date-button" id="date-selector-btn">
                                <span id="selected-date-text">日付を選択</span>
                            </button>
                            <span style="font-size: 14px; color: #6b7280;">📅 クリックして日付を選択</span>
                        </div>
                    </div>

                    <!-- OUT/IN/夜勤設定 -->
                    <div class="plan-uph-container" style="grid-template-columns: 1fr 1fr 1fr;">
                        <!-- OUT設定 -->
                        <div class="plan-uph-section out-section">
                            <div class="plan-uph-title">OUT設定</div>
                            <div class="setting-row">
                                <span class="setting-label">PLAN:</span>
                                <input type="number" id="out-plan" class="setting-input" value="">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">UPH:</span>
                                <input type="number" id="out-uph" class="setting-input" value="">
                            </div>
                        </div>

                        <!-- IN設定 -->
                        <div class="plan-uph-section in-section">
                            <div class="plan-uph-title">IN設定</div>
                            <div class="setting-row">
                                <span class="setting-label">PLAN:</span>
                                <input type="number" id="in-plan" class="setting-input" value="">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">UPH:</span>
                                <input type="number" id="in-uph" class="setting-input" value="">
                            </div>
                        </div>

                        <!-- 夜勤設定 -->
                        <div class="plan-uph-section night-section">
                            <div class="plan-uph-title">夜勤設定</div>
                            <div class="setting-row">
                                <span class="setting-label">PLAN:</span>
                                <input type="number" id="night-plan" class="setting-input" value="3000">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">UPH:</span>
                                <input type="number" id="night-uph" class="setting-input" value="45">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OUT/IN/夜勤分析（3列並び） -->
                <div class="analysis-container">
                    <!-- OUT分析 -->
                    <div class="analysis-section">
                        <h2 class="analysis-title out-title">
                            <span>📤</span>
                            OUT 分析
                        </h2>
                        
                        <div class="analysis-content">
                            <div class="summary-card out-summary" style="margin: 0;">
                                <div class="grid grid-4">
                                    <div class="stat-card">
                                        <div class="stat-value stat-blue" id="out-worker-count">0</div>
                                        <div class="stat-label">勤務者数</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-green" id="out-actual-lh">0.0</div>
                                        <div class="stat-label">実働LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-orange" id="out-required-lh">0.0</div>
                                        <div class="stat-label">必要LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value" id="out-shortage-lh">0.0</div>
                                        <div class="stat-label">過不足</div>
                                    </div>
                                </div>
                                
                                <div id="out-shortage-alert"></div>
                            </div>

                            <div class="employee-list-container">
                                <div id="out-employee-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- IN分析 -->
                    <div class="analysis-section">
                        <h2 class="analysis-title in-title">
                            <span>📥</span>
                            IN 分析
                        </h2>
                        
                        <div class="analysis-content">
                            <div class="summary-card in-summary" style="margin: 0;">
                                <div class="grid grid-4">
                                    <div class="stat-card">
                                        <div class="stat-value stat-blue" id="in-worker-count">0</div>
                                        <div class="stat-label">勤務者数</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-green" id="in-actual-lh">0.0</div>
                                        <div class="stat-label">実働LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-orange" id="in-required-lh">0.0</div>
                                        <div class="stat-label">必要LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value" id="in-shortage-lh">0.0</div>
                                        <div class="stat-label">過不足</div>
                                    </div>
                                </div>
                                
                                <div id="in-shortage-alert"></div>
                            </div>

                            <div class="employee-list-container">
                                <div id="in-employee-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 夜勤分析 -->
                    <div class="analysis-section">
                        <h2 class="analysis-title night-title">
                            <span>🌙</span>
                            夜勤 分析
                        </h2>
                        
                        <div class="analysis-content">
                            <div class="summary-card night-summary" style="margin: 0;">
                                <div class="grid grid-4">
                                    <div class="stat-card">
                                        <div class="stat-value stat-blue" id="night-worker-count">0</div>
                                        <div class="stat-label">勤務者数</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-green" id="night-actual-lh">0.0</div>
                                        <div class="stat-label">実働LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-orange" id="night-required-lh">0.0</div>
                                        <div class="stat-label">必要LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value" id="night-shortage-lh">0.0</div>
                                        <div class="stat-label">過不足</div>
                                    </div>
                                </div>
                                
                                <div id="night-shortage-alert"></div>
                            </div>

                            <div class="employee-list-container">
                                <div id="night-employee-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 印刷セクション -->
                <div class="print-section">
                    <h2 class="analysis-title" style="color: #1f2937; background: none; padding: 0;">
                        <span>🖨️</span>
                        最適化印刷（行数対応版）
                    </h2>
                    
                    <!-- 単日印刷 -->
                    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #059669; border-radius: 8px; background: #f0fdf4;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #047857; margin-bottom: 12px;">📄 単日印刷（最適化版）</h3>
                        
                        <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-size: 14px; color: #166534; font-weight: 500;">
                                ✅ 印刷最適化: 行数に応じた最適なページ数、空白ページ排除
                            </div>
                            <div style="font-size: 12px; color: #15803d; margin-top: 4px;">
                                • 実際のデータ行数に応じて自動でページ数を調整<br>
                                • 文字サイズ固定で読みやすさを維持<br>
                                • 不要な空白や余白を最小化して用紙を有効活用
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
                            <button class="print-button" id="print-button">
                                <span>🖨️</span>
                                最適化印刷
                            </button>
                            <button class="print-button" id="print-preview-button" style="background: #6b7280;">
                                <span>👁️</span>
                                プレビュー
                            </button>
                            <span style="font-size: 14px; color: #047857;">
                                行数に応じた最適なページ数で印刷<br>
                                <small>※会社名と氏名が同じ場合、氏名欄は空白で印刷されます</small>
                            </span>
                        </div>
                    </div>

                    <!-- 複数日印刷 -->
                    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #3b82f6; border-radius: 8px; background: #eff6ff;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 12px;">📅 複数日印刷（最適化版）</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label class="label">開始日</label>
                                <button class="date-button" id="start-date-selector-btn">
                                    <span id="start-date-text">開始日を選択</span>
                                </button>
                            </div>
                            <div>
                                <label class="label">終了日</label>
                                <button class="date-button" id="end-date-selector-btn">
                                    <span id="end-date-text">終了日を選択</span>
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 12px;">
                            <button class="print-button" id="multi-print-button" style="background: #3b82f6;">
                                <span>📋</span>
                                範囲印刷
                            </button>
                            <button class="print-button" id="multi-preview-button" style="background: #6b7280;">
                                <span>👁️</span>
                                範囲プレビュー
                            </button>
                            <button class="btn btn-secondary" id="debug-range-button" style="font-size: 12px;">
                                🔍 範囲状態確認
                            </button>
                        </div>
                        
                        <div style="font-size: 14px; color: #1e40af; margin-bottom: 8px;">
                            指定した期間のシフト表を連続印刷（各日最適化）
                        </div>

                        <div id="range-info" style="font-size: 14px; color: #1e40af; background: white; padding: 8px; border-radius: 4px; display: none;">
                            選択期間: <span id="range-summary"></span> | 
                            総ページ数: <span id="page-count">0</span>ページ
                        </div>
                    </div>

                    <div class="print-preview" id="print-preview" style="display: none;">
                        <div class="print-content" id="print-content">
                            <!-- 印刷内容がここに生成される -->
                        </div>
                    </div>
                </div>

                <!-- デバッグパネル（メイン画面用） -->
                <div class="debug-panel" id="main-debug-panel" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 8px;">詳細ログ:</div>
                    <div id="main-debug-log"></div>
                </div>
            </div>

            <!-- カレンダーポップアップ -->
            <div class="calendar-popup" id="calendar-popup">
                <div class="calendar-content">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1f2937;">📅 日付を選択</h3>
                    <div class="calendar-header">
                        <button class="calendar-nav" id="prev-month">‹</button>
                        <div class="calendar-title" id="calendar-title"></div>
                        <button class="calendar-nav" id="next-month">›</button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                    <button class="calendar-close" id="calendar-close">閉じる</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let employees = [];
        let dateColumns = [];
        let currentFile = null;
        let currentDate = null;
        let currentMonth = new Date();
        let dailyOutSettings = {};
        let dailyInSettings = {};
        let dailyNightSettings = {};
        let fileHash = null;
        let debugMode = false;
        let startDate = null;
        let endDate = null;
        let dateSelectionMode = 'single';

        // デバッグログ機能
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            console.log(logMessage);
            
            const debugPanel = document.getElementById('debug-log') || document.getElementById('main-debug-log');
            if (debugPanel) {
                const div = document.createElement('div');
                div.style.color = type === 'error' ? '#dc2626' : type === 'warning' ? '#f59e0b' : '#374151';
                div.textContent = logMessage;
                debugPanel.appendChild(div);
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
        }

        // ファイルハッシュ生成
        async function generateFileHash(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                let hash = 0;
                for (let i = 0; i < uint8Array.length; i++) {
                    hash = ((hash << 5) - hash + uint8Array[i]) & 0xffffffff;
                }
                return hash.toString(16);
            } catch (error) {
                debugLog(`ファイルハッシュ生成エラー: ${error.message}`, 'error');
                return Date.now().toString();
            }
        }

        // 日付範囲取得関数
        function getDateRange(startDateString, endDateString) {
            const start = new Date(startDateString);
            const end = new Date(endDateString);
            const dateArray = [];
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateString = date.toLocaleDateString('ja-JP');
                // 利用可能な日付のみ追加
                if (dateColumns.some(col => col.dateString === dateString)) {
                    dateArray.push(dateString);
                }
            }
            
            return dateArray;
        }

        // 時間帯判定関数
        function getShiftType(timeSlot) {
            if (isNightShift(timeSlot)) {
                return '夜勤';
            } else {
                return '日勤';
            }
        }

        // 最適化印刷プレビュー表示関数
        window.showPrintPreview = function() {
            if (!currentDate) {
                alert('まず日付を選択してください');
                return;
            }

            debugLog('📄 最適化印刷プレビューを生成中...', 'info');

            const allEmployees = getAllWorkingEmployees(currentDate);
            const sameNameCompanyCount = allEmployees.filter(emp => emp.company === emp.name).length;
            if (sameNameCompanyCount > 0) {
                debugLog(`📝 会社名=氏名の従業員: ${sameNameCompanyCount}名（印刷時は氏名を空白化）`, 'info');
            }
            const outEmployees = getWorkingEmployees(currentDate, 'OUT');
            const inEmployees = getWorkingEmployees(currentDate, 'IN');
            const nightEmployees = getNightShiftEmployees(currentDate);
            const outStats = calculateStats(outEmployees, 'out');
            const inStats = calculateStats(inEmployees, 'in');
            const nightStats = calculateStats(nightEmployees, 'night');

            const totalWorkers = allEmployees.length;
            const totalLH = allEmployees.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0);
            const outPlan = parseInt(document.getElementById('out-plan').value) || 0;
            const inPlan = parseInt(document.getElementById('in-plan').value) || 0;
            const nightPlan = parseInt(document.getElementById('night-plan').value) || 0;
            const totalRequiredLH = outStats.requiredLH + inStats.requiredLH + nightStats.requiredLH;
            const shortage = totalLH - totalRequiredLH;

            const employeesWithCategory = allEmployees.map(emp => {
                const category = categorizeWorkStatus(emp.dailyStatuses[currentDate], emp.timeSlot);
                const printName = emp.company === emp.name ? '' : emp.name;
                const shiftType = getShiftType(emp.timeSlot);
                return { ...emp, category: category, printName: printName, shiftType: shiftType };
            }).sort((a, b) => {
                // 日勤を先に、夜勤を後にソート
                if (a.shiftType === '日勤' && b.shiftType === '夜勤') return -1;
                if (a.shiftType === '夜勤' && b.shiftType === '日勤') return 1;
                return 0;
            });

            const printContent = `
                <div class="print-day-container print-single-day">
                    <div class="print-header">
                        <div class="print-title">${currentDate} 日勤シフト表</div>
                        <div style="font-size: 12px;">出退勤確認表</div>
                    </div>

                    <div class="print-stats">
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">出勤HC</div>
                            <div>${totalWorkers}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">出勤LH</div>
                            <div>${totalLH.toFixed(2)}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">OUT PLAN</div>
                            <div>${outPlan.toLocaleString()}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">IN PLAN</div>
                            <div>${inPlan.toLocaleString()}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">夜勤 PLAN</div>
                            <div>${nightPlan.toLocaleString()}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">必要LH</div>
                            <div>${totalRequiredLH.toFixed(2)}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold; color: ${shortage < 0 ? '#dc2626' : '#059669'};">過不足</div>
                            <div style="color: ${shortage < 0 ? '#dc2626' : '#059669'};">${shortage > 0 ? '+' : ''}${shortage.toFixed(2)}</div>
                        </div>
                    </div>

                    <table class="print-table">
                        <caption class="print-table-caption">${currentDate} 勤務者一覧 (${totalWorkers}名)</caption>
                        <thead>
                            <tr>
                                <th style="width: 8%;">時間帯</th>
                                <th style="width: 16%;">会社名</th>
                                <th style="width: 13%;">メイン業務</th>
                                <th style="width: 13%;">氏名</th>
                                <th style="width: 7%;">開始時間</th>
                                <th style="width: 7%;">終了時間</th>
                                <th style="width: 6%;">休憩</th>
                                <th style="width: 10%;">自己申告<br>体調</th>
                                <th style="width: 10%;">熱中症<br>対策確認</th>
                                <th style="width: 10%;">備考</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${employeesWithCategory.map(emp => `
                                <tr>
                                    <td style="text-align: center; font-size: 8px; font-weight: bold; color: ${emp.shiftType === '夜勤' ? '#7c3aed' : '#374151'};">${emp.shiftType}</td>
                                    <td style="text-align: center;">${emp.company}</td>
                                    <td style="text-align: center;">${emp.baseAssignment}</td>
                                    <td style="font-weight: bold; text-align: center;">${emp.printName}</td>
                                    <td style="text-align: center;">:</td>
                                    <td style="text-align: center;">:</td>
                                    <td style="text-align: center;">:</td>
                                    <td style="text-align: center;"></td>
                                    <td style="text-align: center;"></td>
                                    <td style="text-align: center;"></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="print-footer">
                        <div>責任者確認：_________________</div>
                        <div>日付：_______________</div>
                    </div>
                </div>
            `;

            const printContentEl = document.getElementById('print-content');
            printContentEl.innerHTML = printContent;
            
            document.getElementById('print-preview').style.display = 'block';
            
            document.getElementById('print-preview').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            debugLog(`✅ 最適化プレビュー生成完了: ${totalWorkers}名、予想ページ数: ${Math.ceil(totalWorkers / 35)}ページ`, 'info');
        };

        // 最適化印刷実行関数
        window.generatePrintSheet = function() {
            if (!currentDate) {
                alert('まず日付を選択してください');
                return;
            }

            debugLog('🖨️ 最適化印刷を実行中...', 'info');
            window.showPrintPreview();

            setTimeout(() => {
                window.print();
                debugLog('📄 最適化印刷処理完了（行数対応）', 'info');
            }, 500);
        };

        // 複数日印刷プレビュー（最適化版）
        window.showMultiPrintPreview = function() {
            if (!startDate || !endDate) {
                alert('開始日と終了日を選択してください');
                return;
            }

            debugLog('📅 複数日最適化プレビューを生成中...', 'info');

            const dateRange = getDateRange(startDate, endDate);
            if (dateRange.length === 0) {
                alert('選択した期間にデータがありません');
                return;
            }

            let multiPrintContent = '';
            let totalEmployeeCount = 0;
            
            dateRange.forEach((date, index) => {
                const allEmployees = getAllWorkingEmployees(date);
                const outEmployees = getWorkingEmployees(date, 'OUT');
                const inEmployees = getWorkingEmployees(date, 'IN');
                const nightEmployees = getNightShiftEmployees(date);
                const outStats = calculateStats(outEmployees, 'out');
                const inStats = calculateStats(inEmployees, 'in');
                const nightStats = calculateStats(nightEmployees, 'night');

                const employeeCount = allEmployees.length;
                totalEmployeeCount = Math.max(totalEmployeeCount, employeeCount);
                
                const totalWorkers = allEmployees.length;
                const totalLH = allEmployees.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0);
                const outPlan = dailyOutSettings[date]?.plan || parseInt(document.getElementById('out-plan').value) || 0;
                const inPlan = dailyInSettings[date]?.plan || parseInt(document.getElementById('in-plan').value) || 0;
                const nightPlan = dailyNightSettings[date]?.plan || parseInt(document.getElementById('night-plan').value) || 0;
                const totalRequiredLH = outStats.requiredLH + inStats.requiredLH + nightStats.requiredLH;
                const shortage = totalLH - totalRequiredLH;

                const employeesWithCategory = allEmployees.map(emp => {
                    const category = categorizeWorkStatus(emp.dailyStatuses[date], emp.timeSlot);
                    const printName = emp.company === emp.name ? '' : emp.name;
                    const shiftType = getShiftType(emp.timeSlot);
                    return { ...emp, category: category, printName: printName, shiftType: shiftType };
                }).sort((a, b) => {
                    // 日勤を先に、夜勤を後にソート
                    if (a.shiftType === '日勤' && b.shiftType === '夜勤') return -1;
                    if (a.shiftType === '夜勤' && b.shiftType === '日勤') return 1;
                    return 0;
                });
                
                multiPrintContent += `
                    <div class="print-day-container print-multi-day" ${index === 0 ? 'style="page-break-before: auto;"' : ''}>
                        <div class="print-header">
                            <div class="print-title">${date} 日勤シフト表</div>
                            <div style="font-size: 12px;">出退勤確認表</div>
                        </div>

                        <div class="print-stats">
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">出勤HC</div>
                                <div>${totalWorkers}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">出勤LH</div>
                                <div>${totalLH.toFixed(2)}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">OUT PLAN</div>
                                <div>${outPlan.toLocaleString()}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">IN PLAN</div>
                                <div>${inPlan.toLocaleString()}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">夜勤 PLAN</div>
                                <div>${nightPlan.toLocaleString()}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">必要LH</div>
                                <div>${totalRequiredLH.toFixed(2)}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold; color: ${shortage < 0 ? '#dc2626' : '#059669'};">過不足</div>
                                <div style="color: ${shortage < 0 ? '#dc2626' : '#059669'};">${shortage > 0 ? '+' : ''}${shortage.toFixed(2)}</div>
                            </div>
                        </div>

                        <table class="print-table">
                            <caption class="print-table-caption">${date} 勤務者一覧 (${totalWorkers}名)</caption>
                            <thead>
                                <tr>
                                    <th style="width: 8%;">時間帯</th>
                                    <th style="width: 16%;">会社名</th>
                                    <th style="width: 13%;">メイン業務</th>
                                    <th style="width: 13%;">氏名</th>
                                    <th style="width: 7%;">開始時間</th>
                                    <th style="width: 7%;">終了時間</th>
                                    <th style="width: 6%;">休憩</th>
                                    <th style="width: 10%;">自己申告<br>体調</th>
                                    <th style="width: 10%;">熱中症<br>対策確認</th>
                                    <th style="width: 10%;">備考</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employeesWithCategory.map(emp => `
                                    <tr>
                                        <td style="text-align: center; font-size: 8px; font-weight: bold; color: ${emp.shiftType === '夜勤' ? '#7c3aed' : '#374151'};">${emp.shiftType}</td>
                                        <td style="text-align: center;">${emp.company}</td>
                                        <td style="text-align: center;">${emp.baseAssignment}</td>
                                        <td style="font-weight: bold; text-align: center;">${emp.printName}</td>
                                        <td style="text-align: center;">:</td>
                                        <td style="text-align: center;">:</td>
                                        <td style="text-align: center;">:</td>
                                        <td style="text-align: center;"></td>
                                        <td style="text-align: center;"></td>
                                        <td style="text-align: center;"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="print-footer">
                            <div>責任者確認：_________________</div>
                            <div>日付：_______________ (${index + 1}/${dateRange.length})</div>
                        </div>
                    </div>
                `;
            });

            const printContent = document.getElementById('print-content');
            printContent.innerHTML = multiPrintContent;
            
            document.getElementById('print-preview').style.display = 'block';
            
            document.getElementById('print-preview').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            debugLog(`✅ 複数日最適化プレビュー生成完了: ${dateRange.length}日分`, 'info');
        };

        // 複数日印刷実行（最適化版）
        window.generateMultiPrintSheet = function() {
            if (!startDate || !endDate) {
                alert('開始日と終了日を選択してください');
                return;
            }

            debugLog('🖨️ 複数日最適化印刷を実行中...', 'info');
            
            // プレビュー生成
            window.showMultiPrintPreview();

            // 印刷実行
            setTimeout(() => {
                window.print();
                debugLog('📄 複数日最適化印刷処理完了', 'info');
            }, 500);
        };

        // デバッグ範囲状態確認
        window.debugRangeStatus = function() {
            debugLog('🔍 範囲状態確認を実行中...', 'info');
            
            const status = {
                'startDate変数': startDate || 'null',
                'endDate変数': endDate || 'null',
                '開始日表示': document.getElementById('start-date-text')?.textContent || 'N/A',
                '終了日表示': document.getElementById('end-date-text')?.textContent || 'N/A',
                '範囲情報表示': document.getElementById('range-info')?.style.display || 'N/A',
                'dateColumns数': dateColumns.length,
                'employees数': employees.length,
                '印刷最適化': '有効'
            };

            let message = '📊 現在の範囲状態:\n\n';
            Object.entries(status).forEach(([key, value]) => {
                message += `${key}: ${value}\n`;
                debugLog(`${key}: ${value}`, 'info');
            });

            if (startDate && endDate) {
                try {
                    const dateRange = getDateRange(startDate, endDate);
                    message += `\n📅 対象期間: ${dateRange.length}日\n`;
                    message += `対象日付: ${dateRange.join(', ')}\n`;
                    debugLog(`対象期間: ${dateRange.length}日`, 'info');
                } catch (error) {
                    message += `\n❌ 範囲計算エラー: ${error.message}\n`;
                    debugLog(`範囲計算エラー: ${error.message}`, 'error');
                }
            }

            message += '\n🖨️ 印刷最適化状況:\n';
            message += '✅ 行数対応印刷: 有効\n';
            message += '✅ 空白ページ排除: 有効\n';
            message += '✅ 文字サイズ固定: 有効\n';

            alert(message);
        };

        function updateLoadingStatus(message, progress = null, details = null) {
            const messageEl = document.getElementById('loading-message');
            const progressEl = document.getElementById('loading-progress');
            const detailsEl = document.getElementById('loading-details');
            
            if (messageEl) messageEl.textContent = message;
            if (progressEl && progress !== null) progressEl.style.width = progress + '%';
            if (detailsEl && details !== null) {
                detailsEl.textContent += (detailsEl.textContent ? '\n' : '') + details;
                detailsEl.scrollTop = detailsEl.scrollHeight;
            }
            
            debugLog(`ローディング: ${message}${details ? ' - ' + details : ''}`, 'info');
        }

        async function loadShiftData(file) {
            showScreen('loading');
            
            const detailsEl = document.getElementById('loading-details');
            if (detailsEl) detailsEl.textContent = '';
            
            try {
                updateLoadingStatus('ファイルを読み込んでいます...', 10, `ファイル: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
                
                const arrayBuffer = await file.arrayBuffer();
                updateLoadingStatus('Excelワークブックを解析中...', 20, `ArrayBuffer作成完了: ${arrayBuffer.byteLength} bytes`);
                
                const workbook = XLSX.read(arrayBuffer, {
                    cellStyles: true,
                    cellFormulas: false,
                    cellDates: true,
                    cellNF: false,
                    sheetStubs: false
                });
                
                updateLoadingStatus('ワークシートを確認中...', 30, `利用可能なシート: ${workbook.SheetNames.join(', ')}`);

                let worksheet = null;
                let sheetName = '';
                
                if (workbook.Sheets['日勤']) {
                    worksheet = workbook.Sheets['日勤'];
                    sheetName = '日勤';
                } else if (workbook.SheetNames.length > 0) {
                    sheetName = workbook.SheetNames[0];
                    worksheet = workbook.Sheets[sheetName];
                }

                if (!worksheet) {
                    throw new Error('読み込み可能なワークシートが見つかりません');
                }
                
                updateLoadingStatus('シート構造を解析中...', 40, `使用するシート: ${sheetName}`);

                if (!worksheet['!ref']) {
                    throw new Error('ワークシートが空です');
                }
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                updateLoadingStatus('データ範囲を確認中...', 50, `シート範囲: ${range.e.r + 1}行 × ${range.e.c + 1}列`);
                
                debugLog(`📊 データサイズ: ${range.e.r + 1}行 × ${range.e.c + 1}列`, 'info');

                // 日付列の収集
                dateColumns = [];
                updateLoadingStatus('日付列を検索中...', 60);
                
                let dateCount = 0;
                for (let col = 10; col <= range.e.c && col < 100; col++) {
                    try {
                        const cellAddress = XLSX.utils.encode_cell({r: 4, c: col});
                        const cell = worksheet[cellAddress];
                        
                        if (cell && cell.v && cell.v instanceof Date) {
                            const date = new Date(cell.v);
                            
                            if (!isNaN(date.getTime())) {
                                const dateString = date.toLocaleDateString('ja-JP');
                                dateColumns.push({
                                    col: col,
                                    date: date,
                                    dateString: dateString
                                });
                                dateCount++;
                            }
                        }
                    } catch (error) {
                        continue;
                    }
                }
                
                if (dateColumns.length === 0) {
                    throw new Error('日付列が見つかりません。5行目（K列以降）に有効な日付が入力されているか確認してください。');
                }
                
                updateLoadingStatus('設定値を読み込み中...', 70, `検出された日付: ${dateColumns.length}日分`);

                // PLAN/UPH設定の読み込み
                dailyOutSettings = {};
                dailyInSettings = {};
                dailyNightSettings = {};
                
                dateColumns.forEach(dateCol => {
                    try {
                        const getNumericCellValue = (row, col, defaultValue) => {
                            try {
                                const cell = worksheet[XLSX.utils.encode_cell({r: row, c: col})];
                                if (cell && typeof cell.v === 'number' && !isNaN(cell.v)) {
                                    return cell.v;
                                }
                                return defaultValue;
                            } catch {
                                return defaultValue;
                            }
                        };
                        
                        dailyOutSettings[dateCol.dateString] = {
                            plan: getNumericCellValue(0, dateCol.col, 20000),
                            uph: getNumericCellValue(1, dateCol.col, 60)
                        };
                        
                        dailyInSettings[dateCol.dateString] = {
                            plan: getNumericCellValue(2, dateCol.col, 20000),
                            uph: getNumericCellValue(3, dateCol.col, 90)
                        };
                        
                        dailyNightSettings[dateCol.dateString] = {
                            plan: 3000,
                            uph: 45
                        };
                    } catch (error) {
                        dailyOutSettings[dateCol.dateString] = { plan: 20000, uph: 60 };
                        dailyInSettings[dateCol.dateString] = { plan: 20000, uph: 90 };
                        dailyNightSettings[dateCol.dateString] = { plan: 3000, uph: 45 };
                    }
                });

                // 従業員データの読み込み
                employees = [];
                updateLoadingStatus('従業員データを読み込み中...', 80);
                
                let processedCount = 0;
                
                for (let row = 5; row <= range.e.r; row++) {
                    try {
                        const getCellValue = (r, c, defaultValue = '') => {
                            try {
                                const cell = worksheet[XLSX.utils.encode_cell({r: r, c: c})];
                                return cell?.v || defaultValue;
                            } catch {
                                return defaultValue;
                            }
                        };
                        
                        const name = getCellValue(row, 3);
                        
                        if (name && typeof name === 'string' && name.trim() !== '') {
                            const timeSlot = String(getCellValue(row, 0));
                            const baseAssignment = String(getCellValue(row, 1));
                            const company = String(getCellValue(row, 2));
                            const startTime = String(getCellValue(row, 6));
                            const endTime = String(getCellValue(row, 7));
                            
                            const breakTimeRaw = getCellValue(row, 8);
                            const workHoursRaw = getCellValue(row, 9);
                            const breakTime = (typeof breakTimeRaw === 'number') ? breakTimeRaw : 0;
                            const workHours = (typeof workHoursRaw === 'number') ? workHoursRaw : 0;

                            let dailyStatuses = {};
                            for (let dateCol of dateColumns) {
                                try {
                                    const status = getCellValue(row, dateCol.col);
                                    dailyStatuses[dateCol.dateString] = String(status);
                                } catch {
                                    dailyStatuses[dateCol.dateString] = '';
                                }
                            }

                            employees.push({
                                rowNumber: row + 1,
                                timeSlot: timeSlot,
                                baseAssignment: baseAssignment,
                                company: company,
                                name: name.trim(),
                                startTime: startTime,
                                endTime: endTime,
                                breakTime: breakTime,
                                workHours: workHours,
                                dailyStatuses: dailyStatuses
                            });
                            
                            processedCount++;
                        }
                    } catch (error) {
                        debugLog(`行 ${row + 1} の処理でエラー: ${error.message}`, 'warning');
                        continue;
                    }
                }
                
                if (employees.length === 0) {
                    throw new Error('従業員データが見つかりません。6行目以降のD列（名前）にデータが入力されているか確認してください。');
                }

                updateLoadingStatus('画面を初期化中...', 90);

                try {
                    initMainScreen();
                    updateFileStatus('ファイル読み込み完了（最適化印刷対応）', 'success');
                    updateLoadingStatus('読み込み完了！', 100, '分析画面に移動しています...');
                    
                    debugLog(`✅ ファイル読み込み完了: ${employees.length}名, ${dateColumns.length}日分 (最適化印刷対応)`, 'info');
                    
                    setTimeout(() => {
                        showScreen('main');
                    }, 500);
                } catch (initError) {
                    debugLog(`❌ 初期化エラー（リカバリ試行）: ${initError.message}`, 'error');
                    
                    try {
                        if (dateColumns.length > 0) {
                            currentMonth = new Date(dateColumns[0].date);
                            currentDate = dateColumns[0].dateString;
                        }
                        
                        updateFileStatus('部分的読み込み完了（一部機能制限）', 'warning');
                        updateLoadingStatus('部分完了', 95, 'いくつかの機能が制限される可能性があります');
                        
                        setTimeout(() => {
                            showScreen('main');
                            
                            setTimeout(() => {
                                try {
                                    debugLog('🔄 遅延初期化を試行中...', 'info');
                                    if (typeof updateDateDisplay === 'function') updateDateDisplay();
                                    if (typeof updateAnalysis === 'function') updateAnalysis();
                                    debugLog('✅ 遅延初期化成功', 'info');
                                } catch (delayedError) {
                                    debugLog(`❌ 遅延初期化失敗: ${delayedError.message}`, 'error');
                                }
                            }, 1000);
                        }, 500);
                    } catch (recoveryError) {
                        debugLog(`❌ リカバリも失敗: ${recoveryError.message}`, 'error');
                        throw initError;
                    }
                }
                
            } catch (error) {
                debugLog(`❌ データの読み込みエラー: ${error.message}`, 'error');
                
                let errorMessage = `ファイルの読み込みに失敗しました:\n\n${error.message}`;
                
                if (error.message.includes('範囲が不正') || error.message.includes('空です')) {
                    errorMessage += '\n\n推奨対処法:\n・ファイルにデータが入力されているか確認\n・ファイルを開いて保存し直してみる';
                } else if (error.message.includes('日付列が見つかりません')) {
                    errorMessage += '\n\n推奨対処法:\n・5行目のK列以降に日付が入力されているか確認\n・日付がExcelの日付形式になっているか確認';
                } else if (error.message.includes('従業員データが見つかりません')) {
                    errorMessage += '\n\n推奨対処法:\n・6行目以降のD列に従業員名が入力されているか確認\n・名前セルが空白でないか確認';
                } else {
                    errorMessage += '\n\n推奨対処法:\n・ファイルが破損していないか確認\n・Excelで開けるか確認\n・ファイルを別名保存してから再試行';
                }
                
                updateLoadingStatus('エラーが発生しました', 0, `エラー詳細: ${error.message}`);
                updateFileStatus('読み込みエラー', 'error');
                
                setTimeout(() => {
                    alert(errorMessage);
                    showScreen('upload');
                }, 1000);
            }
        }

        function showScreen(screenName) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.add('hidden');
            
            document.getElementById(screenName + '-screen').classList.remove('hidden');
            
            debugLog(`画面切り替え: ${screenName}`, 'info');
        }

        function initMainScreen() {
            try {
                debugLog('メイン画面を初期化中...（最適化印刷版）', 'info');
                
                if (currentFile && currentFile.name) {
                    const filenameEl = document.getElementById('current-filename');
                    if (filenameEl) {
                        filenameEl.textContent = currentFile.name;
                    }
                }
                
                if (dateColumns.length > 0) {
                    // 当日の日付を優先して選択
                    const today = new Date().toLocaleDateString('ja-JP');
                    const todayColumn = dateColumns.find(col => col.dateString === today);
                    
                    if (todayColumn) {
                        currentDate = today;
                        currentMonth = new Date(todayColumn.date);
                        debugLog(`当日の日付を選択: ${currentDate}`, 'info');
                    } else {
                        // 当日がない場合は最初の日付を選択
                        currentMonth = new Date(dateColumns[0].date);
                        currentDate = dateColumns[0].dateString;
                        debugLog(`当日が見つからないため最初の日付を選択: ${currentDate}`, 'info');
                    }
                }
                
                initCalendar();
                
                const elements = {
                    'date-selector-btn': showCalendarPopup,
                    'start-date-selector-btn': () => {
                        try {
                            showCalendarPopupForRange('start');
                        } catch (e) {
                            debugLog(`❌ 開始日選択エラー: ${e.message}`, 'error');
                        }
                    },
                    'end-date-selector-btn': () => {
                        try {
                            showCalendarPopupForRange('end');
                        } catch (e) {
                            debugLog(`❌ 終了日選択エラー: ${e.message}`, 'error');
                        }
                    },
                    'calendar-close': hideCalendarPopup,
                    'prev-month': () => {
                        currentMonth.setMonth(currentMonth.getMonth() - 1);
                        updateCalendar();
                    },
                    'next-month': () => {
                        currentMonth.setMonth(currentMonth.getMonth() + 1);
                        updateCalendar();
                    },
                    'out-plan': updateAnalysis,
                    'out-uph': updateAnalysis,
                    'in-plan': updateAnalysis,
                    'in-uph': updateAnalysis,
                    'night-plan': updateAnalysis,
                    'night-uph': updateAnalysis,
                    'print-button': () => {
                        try {
                            if (typeof generatePrintSheet === 'function') {
                                generatePrintSheet();
                            } else {
                                debugLog('❌ generatePrintSheet関数が未定義', 'error');
                            }
                        } catch (e) {
                            debugLog(`❌ 印刷エラー: ${e.message}`, 'error');
                        }
                    },
                    'print-preview-button': () => {
                        try {
                            if (typeof showPrintPreview === 'function') {
                                showPrintPreview();
                            } else {
                                debugLog('❌ showPrintPreview関数が未定義', 'error');
                            }
                        } catch (e) {
                            debugLog(`❌ プレビューエラー: ${e.message}`, 'error');
                        }
                    },
                    'multi-print-button': () => {
                        try {
                            if (typeof generateMultiPrintSheet === 'function') {
                                generateMultiPrintSheet();
                            } else {
                                debugLog('❌ generateMultiPrintSheet関数が未定義', 'error');
                                alert('複数日印刷機能を初期化中です。少し待ってから再試行してください。');
                            }
                        } catch (e) {
                            debugLog(`❌ 複数日印刷エラー: ${e.message}`, 'error');
                        }
                    },
                    'multi-preview-button': () => {
                        try {
                            if (typeof showMultiPrintPreview === 'function') {
                                showMultiPrintPreview();
                            } else {
                                debugLog('❌ showMultiPrintPreview関数が未定義', 'error');
                                alert('複数日プレビュー機能を初期化中です。少し待ってから再試行してください。');
                            }
                        } catch (e) {
                            debugLog(`❌ 複数日プレビューエラー: ${e.message}`, 'error');
                        }
                    },
                    'debug-range-button': () => {
                        try {
                            if (typeof debugRangeStatus === 'function') {
                                debugRangeStatus();
                            } else {
                                debugLog('❌ debugRangeStatus関数が未定義', 'error');
                            }
                        } catch (e) {
                            debugLog(`❌ デバッグエラー: ${e.message}`, 'error');
                        }
                    },
                    'force-reset-btn': forceReset,
                    'toggle-debug-btn': toggleDebug
                };
                
                Object.keys(elements).forEach(id => {
                    try {
                        const element = document.getElementById(id);
                        if (element) {
                            const handler = elements[id];
                            
                            const newElement = element.cloneNode(true);
                            element.parentNode.replaceChild(newElement, element);
                            
                            const refreshedElement = document.getElementById(id);
                            if (refreshedElement) {
                                if (id.includes('plan') || id.includes('uph')) {
                                    refreshedElement.addEventListener('input', handler);
                                    debugLog(`📝 inputイベント設定: ${id}`, 'info');
                                } else {
                                    refreshedElement.addEventListener('click', (e) => {
                                        try {
                                            debugLog(`🖱️ ${id} クリック検出`, 'info');
                                            handler(e);
                                        } catch (error) {
                                            debugLog(`❌ ${id} ハンドラーエラー: ${error.message}`, 'error');
                                        }
                                    });
                                    debugLog(`🖱️ clickイベント設定: ${id}`, 'info');
                                }
                            }
                        } else {
                            debugLog('❌ 要素が見つかりません: ' + id, 'error');
                        }
                    } catch (error) {
                        debugLog('❌ イベント設定エラー (' + id + '): ' + error.message, 'error');
                    }
                });
                
                const calendarPopup = document.getElementById('calendar-popup');
                if (calendarPopup) {
                    calendarPopup.addEventListener('click', (e) => {
                        if (e.target.id === 'calendar-popup') {
                            hideCalendarPopup();
                        }
                    });
                }

                updateDateDisplay();
                updateRangeDateDisplay();
                updateDateSettings();
                updateAnalysis();
                
                debugLog('✅ メイン画面初期化完了（最適化印刷版）', 'info');
            } catch (error) {
                debugLog(`❌ メイン画面初期化エラー: ${error.message}`, 'error');
                throw error;
            }
        }

        function showCalendarPopup() {
            dateSelectionMode = 'single';
            document.getElementById('calendar-popup').classList.add('show');
            updateCalendar();
        }

        function showCalendarPopupForRange(type) {
            dateSelectionMode = type;
            document.getElementById('calendar-popup').classList.add('show');
            updateCalendar();
            debugLog(`カレンダーポップアップ表示: ${type}日選択モード`, 'info');
        }

        function hideCalendarPopup() {
            document.getElementById('calendar-popup').classList.remove('show');
            dateSelectionMode = 'single';
        }

        function updateDateDisplay() {
            const dateText = currentDate || '日付を選択';
            document.getElementById('selected-date-text').textContent = dateText;
            
            const btn = document.getElementById('date-selector-btn');
            if (currentDate) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        }

        function updateRangeDateDisplay() {
            var startDateText = startDate || '開始日を選択';
            var endDateText = endDate || '終了日を選択';
            
            debugLog('🔍 範囲表示更新: startDate="' + startDate + '", endDate="' + endDate + '"', 'info');
            
            document.getElementById('start-date-text').textContent = startDateText;
            document.getElementById('end-date-text').textContent = endDateText;
            
            if (startDate && endDate) {
                try {
                    var dateRange = getDateRange(startDate, endDate);
                    var rangeInfo = document.getElementById('range-info');
                    var rangeSummary = document.getElementById('range-summary');
                    var pageCount = document.getElementById('page-count');
                    
                    debugLog('📊 範囲計算結果: ' + dateRange.length + '日分', 'info');
                    
                    if (rangeSummary && pageCount && rangeInfo) {
                        rangeSummary.textContent = startDate + ' ～ ' + endDate + ' (' + dateRange.length + '日)';
                        pageCount.textContent = dateRange.length;
                        rangeInfo.style.display = 'block';
                        
                        debugLog('✅ 範囲情報表示完了: ' + startDate + ' ～ ' + endDate + ' (' + dateRange.length + '日)', 'info');
                    } else {
                        debugLog('❌ 範囲情報要素が見つかりません', 'error');
                    }
                } catch (error) {
                    debugLog('❌ 範囲計算エラー: ' + error.message, 'error');
                }
            } else {
                var rangeInfo = document.getElementById('range-info');
                if (rangeInfo) {
                    rangeInfo.style.display = 'none';
                }
                debugLog('⚪ 範囲情報非表示（日付未選択）', 'info');
            }
        }

        function initCalendar() {
            updateCalendar();
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendar-title');
            const calendarGrid = document.getElementById('calendar-grid');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            calendarTitle.textContent = `${year}年${month + 1}月`;
            
            calendarGrid.innerHTML = '';
            
            const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.fontWeight = '600';
                dayHeader.style.color = '#6b7280';
                dayHeader.style.padding = '8px 4px';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.fontSize = '12px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                const dateString = date.toLocaleDateString('ja-JP');
                const dayOfWeek = date.getDay();
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else if (dayOfWeek === 0) {
                    dayElement.classList.add('weekend');
                } else if (dayOfWeek === 6) {
                    dayElement.classList.add('saturday');
                }
                
                const hasData = dateColumns.some(col => col.dateString === dateString);
                if (hasData) {
                    dayElement.style.cursor = 'pointer';
                    dayElement.addEventListener('click', () => {
                        if (dateSelectionMode === 'single') {
                            selectDate(dateString);
                        } else if (dateSelectionMode === 'start') {
                            selectStartDate(dateString);
                        } else if (dateSelectionMode === 'end') {
                            selectEndDate(dateString);
                        }
                    });
                    
                    if (dateSelectionMode === 'single' && dateString === currentDate) {
                        dayElement.classList.add('selected');
                    } else if (dateSelectionMode === 'start' && dateString === startDate) {
                        dayElement.classList.add('selected');
                    } else if (dateSelectionMode === 'end' && dateString === endDate) {
                        dayElement.classList.add('selected');
                    }
                } else {
                    dayElement.style.opacity = '0.3';
                    dayElement.style.cursor = 'not-allowed';
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function selectDate(dateString) {
            currentDate = dateString;
            updateCalendar();
            updateDateDisplay();
            updateDateSettings();
            updateAnalysis();
            hideCalendarPopup();
            
            debugLog(`日付選択: ${dateString}`, 'info');
        }

        function selectStartDate(dateString) {
            startDate = dateString;
            debugLog('📅 開始日選択: ' + dateString, 'info');
            updateCalendar();
            updateRangeDateDisplay();
            hideCalendarPopup();
        }

        function selectEndDate(dateString) {
            endDate = dateString;
            debugLog('📅 終了日選択: ' + dateString, 'info');
            updateCalendar();
            updateRangeDateDisplay();
            hideCalendarPopup();
        }

        function updateDateSettings() {
            if (currentDate && dailyOutSettings[currentDate] && dailyInSettings[currentDate]) {
                // 対象日にデータがある場合は設定値を表示
                document.getElementById('out-plan').value = dailyOutSettings[currentDate].plan;
                document.getElementById('out-uph').value = dailyOutSettings[currentDate].uph;
                document.getElementById('in-plan').value = dailyInSettings[currentDate].plan;
                document.getElementById('in-uph').value = dailyInSettings[currentDate].uph;
                
                debugLog(`設定更新: OUT(${dailyOutSettings[currentDate].plan}/${dailyOutSettings[currentDate].uph}) IN(${dailyInSettings[currentDate].plan}/${dailyInSettings[currentDate].uph})`, 'info');
            } else {
                // 対象日にデータがない場合は空白
                document.getElementById('out-plan').value = '';
                document.getElementById('out-uph').value = '';
                document.getElementById('in-plan').value = '';
                document.getElementById('in-uph').value = '';
                
                debugLog(`設定クリア: 対象日 ${currentDate} にデータがありません`, 'info');
            }
            
            // 夜勤設定は現状のまま維持
            if (currentDate && dailyNightSettings[currentDate]) {
                document.getElementById('night-plan').value = dailyNightSettings[currentDate].plan;
                document.getElementById('night-uph').value = dailyNightSettings[currentDate].uph;
            }
        }

        function updateAnalysis() {
            if (!currentDate) return;

            debugLog(`分析更新: ${currentDate}`, 'info');

            const outEmployees = getWorkingEmployees(currentDate, 'OUT');
            const outStats = calculateStats(outEmployees, 'out');
            updateStatsDisplay('out', outStats);
            updateEmployeeList('out', outEmployees);

            const inEmployees = getWorkingEmployees(currentDate, 'IN');
            const inStats = calculateStats(inEmployees, 'in');
            updateStatsDisplay('in', inStats);
            updateEmployeeList('in', inEmployees);

            const nightEmployees = getNightShiftEmployees(currentDate);
            const nightStats = calculateStats(nightEmployees, 'night');
            updateStatsDisplay('night', nightStats);
            updateEmployeeList('night', nightEmployees);
        }

        function getWorkingEmployees(date, type) {
            return employees.filter(emp => {
                const status = emp.dailyStatuses[date];
                if (!status || status === '休' || status === '有休' || status === '') {
                    return false;
                }
                
                const category = categorizeWorkStatus(status, emp.timeSlot);
                return category === type;
            });
        }

        function getNightShiftEmployees(date) {
            return employees.filter(emp => {
                const status = emp.dailyStatuses[date];
                if (!status || status === '休' || status === '有休' || status === '') {
                    return false;
                }
                
                return isNightShift(emp.timeSlot);
            });
        }

        function getAllWorkingEmployees(date) {
            return employees.filter(emp => {
                const status = emp.dailyStatuses[date];
                return status && status !== '休' && status !== '有休' && status !== '';
            });
        }

        function calculateStats(workingEmps, type) {
            const plan = parseInt(document.getElementById(`${type}-plan`).value) || 0;
            const uph = parseInt(document.getElementById(`${type}-uph`).value) || 0;
            
            const totalLH = workingEmps.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0);
            const requiredLH = totalLH > 0 && uph > 0 ? plan / uph : 0;
            const shortage = totalLH - requiredLH;
            
            return {
                workerCount: workingEmps.length,
                actualLH: totalLH,
                requiredLH: requiredLH,
                shortage: shortage,
                plan: plan,
                uph: uph
            };
        }

        function updateStatsDisplay(type, stats) {
            document.getElementById(`${type}-worker-count`).textContent = stats.workerCount;
            document.getElementById(`${type}-actual-lh`).textContent = stats.actualLH.toFixed(1);
            document.getElementById(`${type}-required-lh`).textContent = stats.requiredLH.toFixed(1);
            
            const shortageLhElement = document.getElementById(`${type}-shortage-lh`);
            const shortageValue = stats.shortage;
            
            if (shortageValue > 0) {
                shortageLhElement.textContent = '+' + shortageValue.toFixed(1);
                shortageLhElement.className = 'stat-value stat-green';
            } else if (shortageValue < 0) {
                shortageLhElement.textContent = shortageValue.toFixed(1);
                shortageLhElement.className = 'stat-value stat-red';
            } else {
                shortageLhElement.textContent = '0.0';
                shortageLhElement.className = 'stat-value stat-blue';
            }

            updateShortageAlert(type, shortageValue);
        }

        function updateShortageAlert(type, shortage) {
            // 提案部分を削除 - アラートは表示しない
            const alertContainer = document.getElementById(`${type}-shortage-alert`);
            if (alertContainer) {
                alertContainer.innerHTML = '';
            }
        }

        function updateEmployeeList(type, workingEmployees) {
            const container = document.getElementById(`${type}-employee-list`);
            
            if (workingEmployees.length === 0) {
                const typeDisplayMap = {
                    'out': 'OUT',
                    'in': 'IN',
                    'night': '夜勤'
                };
                container.innerHTML = `
                    <div style="text-align: center; padding: 32px; color: #6b7280;">
                        ${typeDisplayMap[type] || type.toUpperCase()}勤務者はいません
                    </div>
                `;
                return;
            }
            
            const typeDisplayMap = {
                'out': 'OUT',
                'in': 'IN',
                'night': '夜勤'
            };
            
            container.innerHTML = `
                <div class="status-header">
                    <div class="status-title">${typeDisplayMap[type] || type.toUpperCase()} 勤務者 (${workingEmployees.length}名)</div>
                    <div class="status-info">
                        総労働時間: ${workingEmployees.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0).toFixed(1)}h
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>名前</th>
                                <th>基本配置</th>
                                <th>時間帯</th>
                                <th>勤務時間</th>
                                <th>労働時間</th>
                                <th>会社</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${workingEmployees.map(emp => `
                                <tr>
                                    <td style="font-weight: 500;">
                                        ${emp.name}
                                        <span style="font-size: 10px; color: #6b7280; margin-left: 4px;">(${emp.rowNumber || '?'}行目)</span>
                                    </td>
                                    <td>${emp.baseAssignment}</td>
                                    <td style="color: ${type === 'night' ? '#7c3aed' : '#6b7280'}; font-weight: 500;">${emp.timeSlot}</td>
                                    <td>
                                        ${emp.startTime}-${emp.endTime}
                                        ${emp.breakTime > 0 ? `<span style="font-size: 12px; color: #6b7280;"> (休憩${emp.breakTime}h)</span>` : ''}
                                    </td>
                                    <td>${emp.workHours}h</td>
                                    <td style="color: #6b7280;">${emp.company}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // 完全リセット機能
        function forceReset() {
            debugLog('🔄 強制リセットを実行中...', 'warning');
            
            if (employees.length > 0) {
                debugLog(`📊 リセット前の統計: 従業員${employees.length}名, 日付${dateColumns.length}日分`, 'info');
            }
            
            employees = [];
            dateColumns = [];
            dailyOutSettings = {};
            dailyInSettings = {};
            dailyNightSettings = {};
            currentDate = null;
            currentFile = null;
            fileHash = null;
            startDate = null;
            endDate = null;
            dateSelectionMode = 'single';
            
            const elementsToReset = [
                'current-filename', 'selected-date-text', 'start-date-text', 'end-date-text',
                'out-worker-count', 'out-actual-lh', 'out-required-lh', 'out-shortage-lh',
                'in-worker-count', 'in-actual-lh', 'in-required-lh', 'in-shortage-lh',
                'night-worker-count', 'night-actual-lh', 'night-required-lh', 'night-shortage-lh',
                'out-employee-list', 'in-employee-list', 'night-employee-list', 'print-preview'
            ];
            
            elementsToReset.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'INPUT') {
                        el.value = '';
                    } else {
                        el.textContent = '';
                        el.innerHTML = '';
                    }
                }
            });
            
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.value = '';
            });
            
            document.getElementById('out-plan').value = '';
            document.getElementById('out-uph').value = '';
            document.getElementById('in-plan').value = '';
            document.getElementById('in-uph').value = '';
            document.getElementById('night-plan').value = 3000;
            document.getElementById('night-uph').value = 45;
            
            document.getElementById('range-info').style.display = 'none';
            document.getElementById('start-date-text').textContent = '開始日を選択';
            document.getElementById('end-date-text').textContent = '終了日を選択';
            
            updateFileStatus('リセット完了', 'warning');
            debugLog('✅ 強制リセット完了', 'info');
            showScreen('upload');
        }

        // ファイル状態更新
        function updateFileStatus(message, status = 'success') {
            const statusEl = document.getElementById('file-status');
            const textEl = document.getElementById('file-status-text');
            const timestampEl = document.getElementById('file-timestamp');
            const indicator = statusEl.querySelector('.status-indicator');
            
            if (textEl) textEl.textContent = message;
            if (timestampEl) timestampEl.textContent = new Date().toLocaleString();
            
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        // デバッグ表示切り替え
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanels = document.querySelectorAll('.debug-panel');
            debugPanels.forEach(panel => {
                panel.style.display = debugMode ? 'block' : 'none';
            });
            
            const btn = document.getElementById('toggle-debug-btn');
            if (btn) {
                btn.textContent = debugMode ? '🐛 デバッグ非表示' : '🐛 デバッグ表示';
            }
            
            debugLog(`デバッグモード: ${debugMode ? 'ON' : 'OFF'}`, 'info');
        }

        // ファイルアップロード処理の初期化
        function initFileUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const newFileInput = document.getElementById('new-file-input');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);

            fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            newFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        }

        async function handleFileSelect(file) {
            if (!file) return;
            
            debugLog(`📁 ファイル選択: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`, 'info');
            
            const fileName = file.name.toLowerCase();
            const validExtensions = ['.xlsx', '.xls'];
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension) {
                const errorMsg = `対応していないファイル形式です。\n\n対応形式: ${validExtensions.join(', ')}\n選択されたファイル: ${file.name}`;
                debugLog(errorMsg, 'error');
                alert(errorMsg);
                return;
            }

            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                const errorMsg = `ファイルサイズが大きすぎます。\n\n最大サイズ: 50MB\nファイルサイズ: ${(file.size / 1024 / 1024).toFixed(1)}MB`;
                debugLog(errorMsg, 'error');
                alert(errorMsg);
                return;
            }

            const newHash = await generateFileHash(file);
            if (fileHash && fileHash === newHash) {
                debugLog('⚠️ 同じファイルが検出されました。強制リセットしてから再読み込みします。', 'warning');
                forceReset();
                setTimeout(() => handleFileSelect(file), 100);
                return;
            }

            fileHash = newHash;
            currentFile = file;
            debugLog(`🔍 ファイルハッシュ: ${fileHash}`, 'info');
            
            employees = [];
            dateColumns = [];
            dailyOutSettings = {};
            dailyInSettings = {};
            currentDate = null;
            
            loadShiftData(file);
        }

        // 夜勤判定ロジック
        function isNightShift(timeSlot) {
            if (!timeSlot) return false;
            
            const timeSlotStr = timeSlot.toString().toUpperCase();
            
            // 夜勤判定キーワード
            const nightKeywords = [
                '夜勤', 'NIGHT', 'N勤', 'B勤', '夜', 'ナイト',
                '22:', '23:', '0:', '1:', '2:', '3:', '4:', '5:',
                '22時', '23時', '0時', '1時', '2時', '3時', '4時', '5時'
            ];
            
            return nightKeywords.some(keyword => timeSlotStr.includes(keyword));
        }

        // 勤務状態分類（夜勤対応版）
        const outTasks = [
            'Pack', 'FL', 'Bulk', 'Ship', 'Shipping', 
            'Out_Fork', 'Out_Indirect', 'OUTQA', 'Out',
            'Outbound', 'Loading', 'Dock'
        ];
        const inTasks = [
            'ICQA', 'Hi', 'Pick', 'pick', 'IN', 'Receive',
            'Read', 'Receiving', 'Inbound', 'Stow',
            'Problem', 'Quality'
        ];
        
        function categorizeWorkStatus(status, timeSlot = null) {
            if (!status || status === '休' || status === '有休' || status === '' || status === '欠勤') {
                return null;
            }
            
            // 夜勤判定を最優先
            if (timeSlot && isNightShift(timeSlot)) {
                return 'NIGHT';
            }
            
            const statusStr = status.toString();
            const statusUpper = statusStr.toUpperCase();
            
            for (let outTask of outTasks) {
                if (statusUpper.includes(outTask.toUpperCase())) {
                    return 'OUT';
                }
            }
            
            for (let inTask of inTasks) {
                if (statusUpper.includes(inTask.toUpperCase())) {
                    return 'IN';
                }
            }
            
            switch (statusUpper) {
                case 'P': case 'PACK': case 'PACKING':
                    return 'OUT';
                case 'I': case 'ICQA': case 'IB': case 'INBOUND':
                    return 'IN';
                case 'F': case 'FL': case 'FLOOR':
                    return 'OUT';
                case 'H': case 'HI': case 'PICK': case 'PICKING':
                    return 'IN';
                case 'R': case 'READ': case 'READING':
                    return 'IN';
                case 'S': case 'SHIP': case 'SHIPPING':
                    return 'OUT';
                case 'B': case 'BULK':
                    return 'OUT';
                default:
                    return 'OUT';
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('🚀 アプリケーション初期化開始（最適化印刷版）', 'info');
            initFileUpload();
            debugLog('✅ 初期化完了（最適化印刷版）', 'info');
        });
    </script>
</body>
</html>
