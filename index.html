<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ•ãƒˆè¡¨åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon {
            color: #2563eb;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
            flex-wrap: wrap;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 64px 32px;
            text-align: center;
            transition: border-color 0.2s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2563eb;
        }

        .upload-area.dragover {
            border-color: #2563eb;
            background-color: #eff6ff;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            background: #eff6ff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .form-group {
            margin-bottom: 16px;
        }

        .label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .input, .select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .date-button {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
            min-width: 150px;
            text-align: center;
        }

        .date-button:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .date-button.selected {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
        }

        .calendar-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .calendar-popup.show {
            display: flex;
        }

        .calendar-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            animation: popup-enter 0.2s ease-out;
        }

        @keyframes popup-enter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .calendar-nav:hover {
            background: #e5e7eb;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #eff6ff;
            border-color: #2563eb;
        }

        .calendar-day.selected {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .calendar-day.other-month {
            color: #9ca3af;
            background: #f9fafb;
        }

        .calendar-day.weekend {
            color: #dc2626;
        }

        .calendar-day.saturday {
            color: #2563eb;
        }

        .calendar-close {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 16px;
            float: right;
        }

        .calendar-close:hover {
            background: #4b5563;
        }

        .plan-uph-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .plan-uph-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }

        .plan-uph-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
            text-align: center;
        }

        .out-section {
            border-left: 4px solid #dc2626;
        }

        .in-section {
            border-left: 4px solid #059669;
        }

        .night-section {
            border-left: 4px solid #7c3aed;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .setting-label {
            font-size: 14px;
            color: #374151;
        }

        .setting-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
        }

        .analysis-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .analysis-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .analysis-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            padding: 16px 24px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .out-title {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .in-title {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .night-title {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .analysis-content {
            padding: 0;
        }

        .employee-list-container {
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid #e5e7eb;
        }

        .print-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid #e5e7eb;
        }

        .print-button {
            background: #059669;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-button:hover {
            background: #047857;
        }

        .print-preview {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 210mm;
            margin-left: auto;
            margin-right: auto;
        }

        .reset-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .file-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .debug-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }

        .print-preview .print-table {
            font-size: 10px;
            margin-bottom: 8px;
        }

        .print-preview .print-table th,
        .print-preview .print-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            line-height: 1.2;
            text-align: center;
            vertical-align: middle;
        }

        .print-preview .print-stats {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 12px;
            font-size: 10px;
        }

        .print-preview .print-stat-item {
            text-align: center;
            border: 1px solid #000;
            padding: 4px;
            vertical-align: middle;
        }

        /* æœ€é©åŒ–å°åˆ·ç”¨CSS - è¡Œæ•°å¯¾å¿œç‰ˆ */
        @media print {
            /* åŸºæœ¬è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ */
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            
            html, body {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
            }
            
            /* éå°åˆ·è¦ç´ ã‚’éè¡¨ç¤º */
            body * {
                visibility: hidden;
            }
            
            .print-content, .print-content * {
                visibility: visible;
            }
            
            /* å°åˆ·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æœ€é©åŒ– */
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 0;
                margin: 0;
                background: white;
                font-size: 10px;
                line-height: 1.2;
                page-break-inside: avoid;
            }

            /* ãƒšãƒ¼ã‚¸è¨­å®š - A4ã‚µã‚¤ã‚ºã€ä½™ç™½æœ€å°åŒ– */
            @page {
                size: A4;
                margin: 8mm 6mm;
                padding: 0;
            }

            /* å°åˆ·å†…å®¹ã‚³ãƒ³ãƒ†ãƒŠ */
            .print-day-container {
                width: 100%;
                height: auto !important;
                max-height: none !important;
                margin: 0;
                padding: 0;
                page-break-before: auto;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */
            .print-header {
                width: 100%;
                text-align: center;
                margin-bottom: 6px;
                border-bottom: 2px solid #000;
                padding-bottom: 4px;
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            .print-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 2px;
            }

            /* çµ±è¨ˆæƒ…å ± */
            .print-stats {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                margin-bottom: 6px;
                font-size: 9px;
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            .print-stat-item {
                text-align: center;
                border: 1px solid #000;
                padding: 2px;
                line-height: 1.1;
                vertical-align: middle;
                height: auto;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«æœ€é©åŒ– - è¡Œæ•°å¯¾å¿œ */
            .print-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 8px;
                margin: 0;
                padding: 0;
                /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ */
                height: auto !important;
                max-height: none !important;
                /* æ”¹ãƒšãƒ¼ã‚¸ã‚’å†…å®¹ã«å¿œã˜ã¦èª¿æ•´ */
                page-break-inside: auto;
                page-break-before: auto;
                page-break-after: auto;
                /* å­¤ç«‹è¡Œãƒ»å¯¡å©¦è¡Œã®åˆ¶å¾¡ */
                orphans: 2;
                widows: 2;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */
            .print-table thead {
                display: table-header-group;
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            .print-table th {
                background: #f0f0f0 !important;
                font-weight: bold;
                text-align: center;
                font-size: 7px;
                border: 1px solid #000;
                padding: 1px 2px;
                /* ãƒ˜ãƒƒãƒ€ãƒ¼é«˜ã•å›ºå®š */
                height: 16pt !important;
                min-height: 16pt !important;
                max-height: 16pt !important;
                line-height: 1.0;
                vertical-align: middle;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œ */
            .print-table tr {
                /* è¡Œã®åˆ†å‰²ã‚’è¨±å¯ã—ã¦è‡ªç„¶ãªæ”¹ãƒšãƒ¼ã‚¸ */
                page-break-inside: auto;
                page-break-after: auto;
            }

            .print-table thead tr {
                page-break-after: avoid;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ« - æ–‡å­—ã‚µã‚¤ã‚ºå›ºå®šã€é«˜ã•æœ€é©åŒ– */
            .print-table td {
                border: 1px solid #000;
                padding: 1px 2px;
                text-align: center;
                vertical-align: middle;
                line-height: 1.0;
                word-wrap: break-word;
                overflow: hidden;
                /* ã‚»ãƒ«é«˜ã•å›ºå®šï¼ˆæ–‡å­—ã‚µã‚¤ã‚ºã«å¯¾å¿œï¼‰ */
                height: 14pt !important;
                min-height: 14pt !important;
                max-height: 14pt !important;
                font-size: 8px !important;
            }

            /* ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ */
            .print-table-caption {
                display: table-caption;
                caption-side: top;
                page-break-inside: avoid;
                page-break-after: avoid;
                font-weight: bold;
                text-align: center;
                margin-bottom: 3px;
                font-size: 11px;
                background: #f0f0f0;
                border: 1px solid #000;
                padding: 3px;
            }

            /* ãƒ•ãƒƒã‚¿ãƒ¼ */
            .print-footer {
                width: 100%;
                margin-top: 4px;
                display: flex;
                justify-content: space-between;
                border-top: 1px solid #000;
                padding-top: 2px;
                font-size: 9px;
                page-break-inside: avoid;
                page-break-before: avoid;
            }

            /* å˜æ—¥å°åˆ·ç‰¹åˆ¥è¨­å®š */
            .print-single-day {
                /* å†…å®¹ã«å®Œå…¨ã«åˆã‚ã›ã‚‹ */
                height: auto !important;
                min-height: auto !important;
                max-height: none !important;
                /* è‡ªç„¶ãªæ”¹ãƒšãƒ¼ã‚¸ */
                page-break-before: auto !important;
                page-break-after: auto !important;
                page-break-inside: auto !important;
            }

            /* è¤‡æ•°æ—¥å°åˆ·ã§ã®æ”¹ãƒšãƒ¼ã‚¸åˆ¶å¾¡ */
            .print-multi-day .print-day-container:not(:first-child) {
                page-break-before: always;
            }

            /* ä¸è¦ãªç©ºç™½ã‚’æ’é™¤ */
            .print-content > *:last-child {
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }

            /* ç©ºã®divã‚„spanã‚’éè¡¨ç¤º */
            .print-content div:empty,
            .print-content span:empty,
            .print-content p:empty {
                display: none !important;
            }

            /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœãƒƒã‚¯ã‚¹ã®å°åˆ·æ™‚èª¿æ•´ */
            .print-preview {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: none !important;
            }
        }

        .summary-card {
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .out-summary {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #dc2626;
        }

        .in-summary {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #059669;
        }

        .night-summary {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-left: 4px solid #7c3aed;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        .stat-blue { color: #2563eb; }
        .stat-green { color: #059669; }
        .stat-orange { color: #d97706; }
        .stat-red { color: #dc2626; }
        .stat-purple { color: #7c3aed; }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .status-section {
            margin-bottom: 24px;
        }

        .status-header {
            background: #f9fafb;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-title {
            font-weight: 600;
            color: #1f2937;
        }

        .status-info {
            font-size: 14px;
            color: #6b7280;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 18px;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }

        .requirement-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .requirement-list h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .requirement-list ul {
            list-style: none;
            padding: 0;
        }

        .requirement-list li {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .requirement-list li::before {
            content: "â€¢";
            color: #2563eb;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .analysis-container {
                grid-template-columns: 1fr;
            }

            .employee-list-container {
                max-height: 300px;
            }

            .calendar-content {
                width: 95%;
                padding: 16px;
            }

            .date-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .date-button {
                min-width: auto;
            }

            .plan-uph-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ -->
        <div id="upload-screen" class="card">
            <div style="text-align: center;">
                <div class="upload-icon">
                    <svg width="24" height="24" fill="none" stroke="#2563eb" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h1 class="title" style="justify-content: center; margin-bottom: 16px;">
                    <span class="icon">ğŸ“…</span>
                    ã‚·ãƒ•ãƒˆè¡¨åˆ†æãƒ„ãƒ¼ãƒ«ï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰
                </h1>
                <p style="color: #6b7280; margin-bottom: 24px;">
                    Excelã‚·ãƒ•ãƒˆè¡¨ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€OUT/INåˆ¥ã®æ—¥åˆ¥å‹¤å‹™çŠ¶æ…‹åˆ†æã¨LHèª¿æ•´ã‚’è¡Œã„ã¾ã™<br>
                    <strong>ğŸ–¨ï¸ å°åˆ·æœ€é©åŒ–:</strong> è¡Œæ•°ã«å¿œã˜ãŸæœ€é©ãªãƒšãƒ¼ã‚¸æ•°ã§å°åˆ·ã€æ–‡å­—ã‚µã‚¤ã‚ºå›ºå®š<br>
                    <strong>ğŸ“„ ç©ºç™½ãƒšãƒ¼ã‚¸æ’é™¤:</strong> ä¸è¦ãªç©ºç™½ãƒšãƒ¼ã‚¸ã‚’å®Œå…¨æ’é™¤ã€ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå°åˆ·<br>
                    <strong>ğŸŒ™ å¤œå‹¤å¯¾å¿œ:</strong> Aåˆ—ã®æ™‚é–“å¸¯æƒ…å ±ã‹ã‚‰å¤œå‹¤ã‚’è‡ªå‹•åˆ¤å®šãƒ»åˆ†æ<br>
                    <strong>æ¥­å‹™è‡ªå‹•åˆ†é¡:</strong> ICQAãƒ»Pickãƒ»Readç­‰â†’INç³»ã€Packãƒ»FLãƒ»Shipç­‰â†’OUTç³»ã«è‡ªå‹•åˆ†é¡<br>
                    <strong>ğŸ—“ï¸ å½“æ—¥å„ªå…ˆ:</strong> å¯¾è±¡æ—¥é¸æŠã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å½“æ—¥ã®æ—¥ä»˜<br>
                    <strong>ğŸ“Š å‹•çš„è¨­å®š:</strong> è¨­å®šå€¤ã¯é¸æŠæ—¥ã«å¿œã˜ã¦è‡ªå‹•èª¿æ•´
                </p>

                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                    <div class="upload-icon">
                        <svg width="24" height="24" fill="none" stroke="#2563eb" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <div style="font-size: 18px; font-weight: 500; color: #374151; margin-bottom: 4px;">
                        ã‚·ãƒ•ãƒˆè¡¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </div>
                    <div style="font-size: 14px; color: #6b7280;">
                        .xlsx ã¾ãŸã¯ .xls ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </div>
                </div>
                
                <div class="requirement-list">
                    <h3>âœ… å°åˆ·æœ€é©åŒ–ï¼ˆNEWï¼‰:</h3>
                    <ul>
                        <li>ğŸ–¨ï¸ <strong>è¡Œæ•°å¯¾å¿œå°åˆ·:</strong> å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ã«å¿œã˜ãŸæœ€é©ãªãƒšãƒ¼ã‚¸æ•°</li>
                        <li>ğŸ“„ <strong>ç©ºç™½ãƒšãƒ¼ã‚¸æ’é™¤:</strong> 5ãƒšãƒ¼ã‚¸â†’å®Ÿéš›ã®è¡Œæ•°åˆ†ã®ã¿å°åˆ·</li>
                        <li>ğŸ¯ <strong>æ–‡å­—ã‚µã‚¤ã‚ºå›ºå®š:</strong> èª­ã¿ã‚„ã™ã•ã‚’ç¶­æŒã—ãŸã¾ã¾æœ€é©åŒ–</li>
                        <li>ğŸ“ <strong>ä½™ç™½æœ€å°åŒ–:</strong> A4ç”¨ç´™ã‚’æœ€å¤§é™æ´»ç”¨</li>
                        <li>ğŸ”§ <strong>æ”¹ãƒšãƒ¼ã‚¸æœ€é©åŒ–:</strong> è‡ªç„¶ãªä½ç½®ã§ã®ãƒšãƒ¼ã‚¸åˆ†å‰²</li>
                        <li>âš¡ <strong>å°åˆ·é«˜é€ŸåŒ–:</strong> ä¸è¦ãªå‡¦ç†ã‚’å‰Šæ¸›ã—å°åˆ·é€Ÿåº¦å‘ä¸Š</li>
                    </ul>
                    
                    <h3>å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼š</h3>
                    <ul>
                        <li>1è¡Œç›®: OUT PLANï¼ˆJåˆ—ä»¥é™ï¼‰</li>
                        <li>2è¡Œç›®: OUTè¨­å®šUPHï¼ˆJåˆ—ä»¥é™ï¼‰</li>
                        <li>3è¡Œç›®: IN PLANï¼ˆJåˆ—ä»¥é™ï¼‰</li>
                        <li>4è¡Œç›®: INè¨­å®šUPHï¼ˆJåˆ—ä»¥é™ï¼‰</li>
                        <li>5è¡Œç›®: æ—¥ä»˜ï¼ˆKåˆ—ä»¥é™ï¼‰</li>
                        <li>6è¡Œç›®ä»¥é™: å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ï¼ˆA-Dåˆ—: åŸºæœ¬æƒ…å ±ã€G-Jåˆ—: æ™‚é–“æƒ…å ±ã€Kåˆ—ä»¥é™: æ—¥åˆ¥å‹¤å‹™çŠ¶æ…‹ï¼‰</li>
                    </ul>
                    
                    <h3 style="margin-top: 16px;">å¯¾å¿œå‹¤å‹™çŠ¶æ…‹ï¼š</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <div>
                            <strong style="color: #dc2626;">OUTç³»:</strong><br>
                            <span style="font-size: 12px;">Pack, FL, Bulk, Ship, Out_Fork, Out_Indirect, OUTQA ãªã©</span>
                        </div>
                        <div>
                            <strong style="color: #059669;">INç³»:</strong><br>
                            <span style="font-size: 12px;">ICQA, Hi, Pick, Read, Receive, Inbound ãªã©</span>
                        </div>
                        <div>
                            <strong style="color: #7c3aed;">å¤œå‹¤:</strong><br>
                            <span style="font-size: 12px;">Aåˆ—ã®æ™‚é–“å¸¯æƒ…å ±ã‹ã‚‰è‡ªå‹•åˆ¤å®šï¼ˆå¤œå‹¤ã€Bå‹¤ã€Nå‹¤ãªã©ï¼‰</span>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
                <div class="debug-panel" id="debug-panel" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 8px;">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°:</div>
                    <div id="debug-log"></div>
                </div>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="loading-screen" class="card hidden">
            <div class="loading">
                <div style="margin-bottom: 16px;">
                    <div id="loading-message">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 4px; margin-top: 8px;">
                        <div id="loading-progress" style="width: 0%; height: 8px; background: #2563eb; border-radius: 4px; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="loading-details" style="font-size: 12px; color: #6b7280; max-height: 200px; overflow-y: auto; text-align: left; white-space: pre-line;"></div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³åˆ†æç”»é¢ -->
        <div id="main-screen" class="hidden">
            <div class="card">
                <div class="header">
                    <h1 class="title">
                        <span class="icon">ğŸ“…</span>
                        ã‚·ãƒ•ãƒˆè¡¨åˆ†æï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰
                    </h1>
                    <div class="file-info">
                        <div>ãƒ•ã‚¡ã‚¤ãƒ«: <span id="current-filename" style="font-weight: 500;"></span></div>
                        <button class="btn btn-warning" id="force-reset-btn">
                            ğŸ”„ å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
                        </button>
                        <button class="btn" onclick="document.getElementById('new-file-input').click()">
                            ğŸ“ æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«
                        </button>
                        <button class="btn btn-secondary" id="toggle-debug-btn">
                            ğŸ› ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
                        </button>
                        <input type="file" id="new-file-input" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>

                <!-- ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹è¡¨ç¤º -->
                <div class="file-status" id="file-status">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="status-indicator status-success"></span>
                        <span id="file-status-text">ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†</span>
                    </div>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                        æœ€çµ‚æ›´æ–°: <span id="file-timestamp"></span>
                    </div>
                </div>

                <!-- æœ€é©åŒ–æƒ…å ± -->
                <div class="reset-section">
                    <h3 style="font-size: 16px; font-weight: 600; color: #059669; margin-bottom: 8px;">
                        ğŸ–¨ï¸ å°åˆ·æœ€é©åŒ–ç‰ˆï¼ˆNEWï¼‰
                    </h3>
                    <div style="font-size: 14px; color: #047857; line-height: 1.6;">
                        <div>ğŸ“„ <strong>è¡Œæ•°å¯¾å¿œå°åˆ·:</strong> å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ã«å¿œã˜ãŸæœ€é©ãªãƒšãƒ¼ã‚¸æ•°</div>
                        <div>ğŸ¯ <strong>ç©ºç™½ãƒšãƒ¼ã‚¸æ’é™¤:</strong> ä¸è¦ãªç©ºç™½ãƒšãƒ¼ã‚¸ã‚’å®Œå…¨æ’é™¤</div>
                        <div>ğŸ“ <strong>æ–‡å­—ã‚µã‚¤ã‚ºå›ºå®š:</strong> èª­ã¿ã‚„ã™ã•ã‚’ç¶­æŒã—ãŸã¾ã¾æœ€é©åŒ–</div>
                        <div>âš¡ <strong>å°åˆ·é«˜é€ŸåŒ–:</strong> åŠ¹ç‡çš„ãªå°åˆ·å‡¦ç†ã§æ™‚é–“çŸ­ç¸®</div>
                        <div>ğŸ“‹ <strong>A4æœ€é©åŒ–:</strong> ç”¨ç´™ã‚’æœ€å¤§é™æ´»ç”¨ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>
                    </div>
                </div>

                <!-- è¨­å®šãƒ‘ãƒãƒ« -->
                <div style="margin-bottom: 24px;">
                    <!-- æ—¥ä»˜é¸æŠ -->
                    <div style="margin-bottom: 16px;">
                        <label class="label">å¯¾è±¡æ—¥é¸æŠ</label>
                        <div class="date-selector">
                            <button class="date-button" id="date-selector-btn">
                                <span id="selected-date-text">æ—¥ä»˜ã‚’é¸æŠ</span>
                            </button>
                            <span style="font-size: 14px; color: #6b7280;">ğŸ“… ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ—¥ä»˜ã‚’é¸æŠ</span>
                        </div>
                    </div>

                    <!-- OUT/IN/å¤œå‹¤è¨­å®š -->
                    <div class="plan-uph-container" style="grid-template-columns: 1fr 1fr 1fr;">
                        <!-- OUTè¨­å®š -->
                        <div class="plan-uph-section out-section">
                            <div class="plan-uph-title">OUTè¨­å®š</div>
                            <div class="setting-row">
                                <span class="setting-label">PLAN:</span>
                                <input type="number" id="out-plan" class="setting-input" value="">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">UPH:</span>
                                <input type="number" id="out-uph" class="setting-input" value="">
                            </div>
                        </div>

                        <!-- INè¨­å®š -->
                        <div class="plan-uph-section in-section">
                            <div class="plan-uph-title">INè¨­å®š</div>
                            <div class="setting-row">
                                <span class="setting-label">PLAN:</span>
                                <input type="number" id="in-plan" class="setting-input" value="">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">UPH:</span>
                                <input type="number" id="in-uph" class="setting-input" value="">
                            </div>
                        </div>

                        <!-- å¤œå‹¤è¨­å®š -->
                        <div class="plan-uph-section night-section">
                            <div class="plan-uph-title">å¤œå‹¤è¨­å®š</div>
                            <div class="setting-row">
                                <span class="setting-label">PLAN:</span>
                                <input type="number" id="night-plan" class="setting-input" value="3000">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">UPH:</span>
                                <input type="number" id="night-uph" class="setting-input" value="45">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OUT/IN/å¤œå‹¤åˆ†æï¼ˆ3åˆ—ä¸¦ã³ï¼‰ -->
                <div class="analysis-container">
                    <!-- OUTåˆ†æ -->
                    <div class="analysis-section">
                        <h2 class="analysis-title out-title">
                            <span>ğŸ“¤</span>
                            OUT åˆ†æ
                        </h2>
                        
                        <div class="analysis-content">
                            <div class="summary-card out-summary" style="margin: 0;">
                                <div class="grid grid-4">
                                    <div class="stat-card">
                                        <div class="stat-value stat-blue" id="out-worker-count">0</div>
                                        <div class="stat-label">å‹¤å‹™è€…æ•°</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-green" id="out-actual-lh">0.0</div>
                                        <div class="stat-label">å®ŸåƒLH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-orange" id="out-required-lh">0.0</div>
                                        <div class="stat-label">å¿…è¦LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value" id="out-shortage-lh">0.0</div>
                                        <div class="stat-label">éä¸è¶³</div>
                                    </div>
                                </div>
                                
                                <div id="out-shortage-alert"></div>
                            </div>

                            <div class="employee-list-container">
                                <div id="out-employee-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- INåˆ†æ -->
                    <div class="analysis-section">
                        <h2 class="analysis-title in-title">
                            <span>ğŸ“¥</span>
                            IN åˆ†æ
                        </h2>
                        
                        <div class="analysis-content">
                            <div class="summary-card in-summary" style="margin: 0;">
                                <div class="grid grid-4">
                                    <div class="stat-card">
                                        <div class="stat-value stat-blue" id="in-worker-count">0</div>
                                        <div class="stat-label">å‹¤å‹™è€…æ•°</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-green" id="in-actual-lh">0.0</div>
                                        <div class="stat-label">å®ŸåƒLH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-orange" id="in-required-lh">0.0</div>
                                        <div class="stat-label">å¿…è¦LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value" id="in-shortage-lh">0.0</div>
                                        <div class="stat-label">éä¸è¶³</div>
                                    </div>
                                </div>
                                
                                <div id="in-shortage-alert"></div>
                            </div>

                            <div class="employee-list-container">
                                <div id="in-employee-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- å¤œå‹¤åˆ†æ -->
                    <div class="analysis-section">
                        <h2 class="analysis-title night-title">
                            <span>ğŸŒ™</span>
                            å¤œå‹¤ åˆ†æ
                        </h2>
                        
                        <div class="analysis-content">
                            <div class="summary-card night-summary" style="margin: 0;">
                                <div class="grid grid-4">
                                    <div class="stat-card">
                                        <div class="stat-value stat-blue" id="night-worker-count">0</div>
                                        <div class="stat-label">å‹¤å‹™è€…æ•°</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-green" id="night-actual-lh">0.0</div>
                                        <div class="stat-label">å®ŸåƒLH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value stat-orange" id="night-required-lh">0.0</div>
                                        <div class="stat-label">å¿…è¦LH</div>
                                    </div>
                                    
                                    <div class="stat-card">
                                        <div class="stat-value" id="night-shortage-lh">0.0</div>
                                        <div class="stat-label">éä¸è¶³</div>
                                    </div>
                                </div>
                                
                                <div id="night-shortage-alert"></div>
                            </div>

                            <div class="employee-list-container">
                                <div id="night-employee-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å°åˆ·ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="print-section">
                    <h2 class="analysis-title" style="color: #1f2937; background: none; padding: 0;">
                        <span>ğŸ–¨ï¸</span>
                        æœ€é©åŒ–å°åˆ·ï¼ˆè¡Œæ•°å¯¾å¿œç‰ˆï¼‰
                    </h2>
                    
                    <!-- å˜æ—¥å°åˆ· -->
                    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #059669; border-radius: 8px; background: #f0fdf4;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #047857; margin-bottom: 12px;">ğŸ“„ å˜æ—¥å°åˆ·ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰</h3>
                        
                        <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-size: 14px; color: #166534; font-weight: 500;">
                                âœ… å°åˆ·æœ€é©åŒ–: è¡Œæ•°ã«å¿œã˜ãŸæœ€é©ãªãƒšãƒ¼ã‚¸æ•°ã€ç©ºç™½ãƒšãƒ¼ã‚¸æ’é™¤
                            </div>
                            <div style="font-size: 12px; color: #15803d; margin-top: 4px;">
                                â€¢ å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ã«å¿œã˜ã¦è‡ªå‹•ã§ãƒšãƒ¼ã‚¸æ•°ã‚’èª¿æ•´<br>
                                â€¢ æ–‡å­—ã‚µã‚¤ã‚ºå›ºå®šã§èª­ã¿ã‚„ã™ã•ã‚’ç¶­æŒ<br>
                                â€¢ ä¸è¦ãªç©ºç™½ã‚„ä½™ç™½ã‚’æœ€å°åŒ–ã—ã¦ç”¨ç´™ã‚’æœ‰åŠ¹æ´»ç”¨
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
                            <button class="print-button" id="print-button">
                                <span>ğŸ–¨ï¸</span>
                                æœ€é©åŒ–å°åˆ·
                            </button>
                            <button class="print-button" id="print-preview-button" style="background: #6b7280;">
                                <span>ğŸ‘ï¸</span>
                                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                            </button>
                            <span style="font-size: 14px; color: #047857;">
                                è¡Œæ•°ã«å¿œã˜ãŸæœ€é©ãªãƒšãƒ¼ã‚¸æ•°ã§å°åˆ·<br>
                                <small>â€»ä¼šç¤¾åã¨æ°åãŒåŒã˜å ´åˆã€æ°åæ¬„ã¯ç©ºç™½ã§å°åˆ·ã•ã‚Œã¾ã™</small>
                            </span>
                        </div>
                    </div>

                    <!-- è¤‡æ•°æ—¥å°åˆ· -->
                    <div style="margin-bottom: 24px; padding: 16px; border: 1px solid #3b82f6; border-radius: 8px; background: #eff6ff;">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 12px;">ğŸ“… è¤‡æ•°æ—¥å°åˆ·ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label class="label">é–‹å§‹æ—¥</label>
                                <button class="date-button" id="start-date-selector-btn">
                                    <span id="start-date-text">é–‹å§‹æ—¥ã‚’é¸æŠ</span>
                                </button>
                            </div>
                            <div>
                                <label class="label">çµ‚äº†æ—¥</label>
                                <button class="date-button" id="end-date-selector-btn">
                                    <span id="end-date-text">çµ‚äº†æ—¥ã‚’é¸æŠ</span>
                                </button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 12px;">
                            <button class="print-button" id="multi-print-button" style="background: #3b82f6;">
                                <span>ğŸ“‹</span>
                                ç¯„å›²å°åˆ·
                            </button>
                            <button class="print-button" id="multi-preview-button" style="background: #6b7280;">
                                <span>ğŸ‘ï¸</span>
                                ç¯„å›²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                            </button>
                            <button class="btn btn-secondary" id="debug-range-button" style="font-size: 12px;">
                                ğŸ” ç¯„å›²çŠ¶æ…‹ç¢ºèª
                            </button>
                        </div>
                        
                        <div style="font-size: 14px; color: #1e40af; margin-bottom: 8px;">
                            æŒ‡å®šã—ãŸæœŸé–“ã®ã‚·ãƒ•ãƒˆè¡¨ã‚’é€£ç¶šå°åˆ·ï¼ˆå„æ—¥æœ€é©åŒ–ï¼‰
                        </div>

                        <div id="range-info" style="font-size: 14px; color: #1e40af; background: white; padding: 8px; border-radius: 4px; display: none;">
                            é¸æŠæœŸé–“: <span id="range-summary"></span> | 
                            ç·ãƒšãƒ¼ã‚¸æ•°: <span id="page-count">0</span>ãƒšãƒ¼ã‚¸
                        </div>
                    </div>

                    <div class="print-preview" id="print-preview" style="display: none;">
                        <div class="print-content" id="print-content">
                            <!-- å°åˆ·å†…å®¹ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ç”¨ï¼‰ -->
                <div class="debug-panel" id="main-debug-panel" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 8px;">è©³ç´°ãƒ­ã‚°:</div>
                    <div id="main-debug-log"></div>
                </div>
            </div>

            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
            <div class="calendar-popup" id="calendar-popup">
                <div class="calendar-content">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1f2937;">ğŸ“… æ—¥ä»˜ã‚’é¸æŠ</h3>
                    <div class="calendar-header">
                        <button class="calendar-nav" id="prev-month">â€¹</button>
                        <div class="calendar-title" id="calendar-title"></div>
                        <button class="calendar-nav" id="next-month">â€º</button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                    <button class="calendar-close" id="calendar-close">é–‰ã˜ã‚‹</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let employees = [];
        let dateColumns = [];
        let currentFile = null;
        let currentDate = null;
        let currentMonth = new Date();
        let dailyOutSettings = {};
        let dailyInSettings = {};
        let dailyNightSettings = {};
        let fileHash = null;
        let debugMode = false;
        let startDate = null;
        let endDate = null;
        let dateSelectionMode = 'single';

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            console.log(logMessage);
            
            const debugPanel = document.getElementById('debug-log') || document.getElementById('main-debug-log');
            if (debugPanel) {
                const div = document.createElement('div');
                div.style.color = type === 'error' ? '#dc2626' : type === 'warning' ? '#f59e0b' : '#374151';
                div.textContent = logMessage;
                debugPanel.appendChild(div);
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
        async function generateFileHash(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                let hash = 0;
                for (let i = 0; i < uint8Array.length; i++) {
                    hash = ((hash << 5) - hash + uint8Array[i]) & 0xffffffff;
                }
                return hash.toString(16);
            } catch (error) {
                debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return Date.now().toString();
            }
        }

        // æ—¥ä»˜ç¯„å›²å–å¾—é–¢æ•°
        function getDateRange(startDateString, endDateString) {
            const start = new Date(startDateString);
            const end = new Date(endDateString);
            const dateArray = [];
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateString = date.toLocaleDateString('ja-JP');
                // åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã®ã¿è¿½åŠ 
                if (dateColumns.some(col => col.dateString === dateString)) {
                    dateArray.push(dateString);
                }
            }
            
            return dateArray;
        }

        // æ™‚é–“å¸¯åˆ¤å®šé–¢æ•°
        function getShiftType(timeSlot) {
            if (isNightShift(timeSlot)) {
                return 'å¤œå‹¤';
            } else {
                return 'æ—¥å‹¤';
            }
        }

        // æœ€é©åŒ–å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé–¢æ•°
        window.showPrintPreview = function() {
            if (!currentDate) {
                alert('ã¾ãšæ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            debugLog('ğŸ“„ æœ€é©åŒ–å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...', 'info');

            const allEmployees = getAllWorkingEmployees(currentDate);
            const sameNameCompanyCount = allEmployees.filter(emp => emp.company === emp.name).length;
            if (sameNameCompanyCount > 0) {
                debugLog(`ğŸ“ ä¼šç¤¾å=æ°åã®å¾“æ¥­å“¡: ${sameNameCompanyCount}åï¼ˆå°åˆ·æ™‚ã¯æ°åã‚’ç©ºç™½åŒ–ï¼‰`, 'info');
            }
            const outEmployees = getWorkingEmployees(currentDate, 'OUT');
            const inEmployees = getWorkingEmployees(currentDate, 'IN');
            const nightEmployees = getNightShiftEmployees(currentDate);
            const outStats = calculateStats(outEmployees, 'out');
            const inStats = calculateStats(inEmployees, 'in');
            const nightStats = calculateStats(nightEmployees, 'night');

            const totalWorkers = allEmployees.length;
            const totalLH = allEmployees.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0);
            const outPlan = parseInt(document.getElementById('out-plan').value) || 0;
            const inPlan = parseInt(document.getElementById('in-plan').value) || 0;
            const nightPlan = parseInt(document.getElementById('night-plan').value) || 0;
            const totalRequiredLH = outStats.requiredLH + inStats.requiredLH + nightStats.requiredLH;
            const shortage = totalLH - totalRequiredLH;

            const employeesWithCategory = allEmployees.map(emp => {
                const category = categorizeWorkStatus(emp.dailyStatuses[currentDate], emp.timeSlot);
                const printName = emp.company === emp.name ? '' : emp.name;
                const shiftType = getShiftType(emp.timeSlot);
                return { ...emp, category: category, printName: printName, shiftType: shiftType };
            }).sort((a, b) => {
                // æ—¥å‹¤ã‚’å…ˆã«ã€å¤œå‹¤ã‚’å¾Œã«ã‚½ãƒ¼ãƒˆ
                if (a.shiftType === 'æ—¥å‹¤' && b.shiftType === 'å¤œå‹¤') return -1;
                if (a.shiftType === 'å¤œå‹¤' && b.shiftType === 'æ—¥å‹¤') return 1;
                return 0;
            });

            const printContent = `
                <div class="print-day-container print-single-day">
                    <div class="print-header">
                        <div class="print-title">${currentDate} æ—¥å‹¤ã‚·ãƒ•ãƒˆè¡¨</div>
                        <div style="font-size: 12px;">å‡ºé€€å‹¤ç¢ºèªè¡¨</div>
                    </div>

                    <div class="print-stats">
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">å‡ºå‹¤HC</div>
                            <div>${totalWorkers}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">å‡ºå‹¤LH</div>
                            <div>${totalLH.toFixed(2)}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">OUT PLAN</div>
                            <div>${outPlan.toLocaleString()}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">IN PLAN</div>
                            <div>${inPlan.toLocaleString()}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">å¤œå‹¤ PLAN</div>
                            <div>${nightPlan.toLocaleString()}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold;">å¿…è¦LH</div>
                            <div>${totalRequiredLH.toFixed(2)}</div>
                        </div>
                        <div class="print-stat-item">
                            <div style="font-weight: bold; color: ${shortage < 0 ? '#dc2626' : '#059669'};">éä¸è¶³</div>
                            <div style="color: ${shortage < 0 ? '#dc2626' : '#059669'};">${shortage > 0 ? '+' : ''}${shortage.toFixed(2)}</div>
                        </div>
                    </div>

                    <table class="print-table">
                        <caption class="print-table-caption">${currentDate} å‹¤å‹™è€…ä¸€è¦§ (${totalWorkers}å)</caption>
                        <thead>
                            <tr>
                                <th style="width: 8%;">æ™‚é–“å¸¯</th>
                                <th style="width: 16%;">ä¼šç¤¾å</th>
                                <th style="width: 13%;">ãƒ¡ã‚¤ãƒ³æ¥­å‹™</th>
                                <th style="width: 13%;">æ°å</th>
                                <th style="width: 7%;">é–‹å§‹æ™‚é–“</th>
                                <th style="width: 7%;">çµ‚äº†æ™‚é–“</th>
                                <th style="width: 6%;">ä¼‘æ†©</th>
                                <th style="width: 10%;">è‡ªå·±ç”³å‘Š<br>ä½“èª¿</th>
                                <th style="width: 10%;">ç†±ä¸­ç—‡<br>å¯¾ç­–ç¢ºèª</th>
                                <th style="width: 10%;">å‚™è€ƒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${employeesWithCategory.map(emp => `
                                <tr>
                                    <td style="text-align: center; font-size: 8px; font-weight: bold; color: ${emp.shiftType === 'å¤œå‹¤' ? '#7c3aed' : '#374151'};">${emp.shiftType}</td>
                                    <td style="text-align: center;">${emp.company}</td>
                                    <td style="text-align: center;">${emp.baseAssignment}</td>
                                    <td style="font-weight: bold; text-align: center;">${emp.printName}</td>
                                    <td style="text-align: center;">:</td>
                                    <td style="text-align: center;">:</td>
                                    <td style="text-align: center;">:</td>
                                    <td style="text-align: center;"></td>
                                    <td style="text-align: center;"></td>
                                    <td style="text-align: center;"></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="print-footer">
                        <div>è²¬ä»»è€…ç¢ºèªï¼š_________________</div>
                        <div>æ—¥ä»˜ï¼š_______________</div>
                    </div>
                </div>
            `;

            const printContentEl = document.getElementById('print-content');
            printContentEl.innerHTML = printContent;
            
            document.getElementById('print-preview').style.display = 'block';
            
            document.getElementById('print-preview').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            debugLog(`âœ… æœ€é©åŒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†: ${totalWorkers}åã€äºˆæƒ³ãƒšãƒ¼ã‚¸æ•°: ${Math.ceil(totalWorkers / 35)}ãƒšãƒ¼ã‚¸`, 'info');
        };

        // æœ€é©åŒ–å°åˆ·å®Ÿè¡Œé–¢æ•°
        window.generatePrintSheet = function() {
            if (!currentDate) {
                alert('ã¾ãšæ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            debugLog('ğŸ–¨ï¸ æœ€é©åŒ–å°åˆ·ã‚’å®Ÿè¡Œä¸­...', 'info');
            window.showPrintPreview();

            setTimeout(() => {
                window.print();
                debugLog('ğŸ“„ æœ€é©åŒ–å°åˆ·å‡¦ç†å®Œäº†ï¼ˆè¡Œæ•°å¯¾å¿œï¼‰', 'info');
            }, 500);
        };

        // è¤‡æ•°æ—¥å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        window.showMultiPrintPreview = function() {
            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            debugLog('ğŸ“… è¤‡æ•°æ—¥æœ€é©åŒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...', 'info');

            const dateRange = getDateRange(startDate, endDate);
            if (dateRange.length === 0) {
                alert('é¸æŠã—ãŸæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let multiPrintContent = '';
            let totalEmployeeCount = 0;
            
            dateRange.forEach((date, index) => {
                const allEmployees = getAllWorkingEmployees(date);
                const outEmployees = getWorkingEmployees(date, 'OUT');
                const inEmployees = getWorkingEmployees(date, 'IN');
                const nightEmployees = getNightShiftEmployees(date);
                const outStats = calculateStats(outEmployees, 'out');
                const inStats = calculateStats(inEmployees, 'in');
                const nightStats = calculateStats(nightEmployees, 'night');

                const employeeCount = allEmployees.length;
                totalEmployeeCount = Math.max(totalEmployeeCount, employeeCount);
                
                const totalWorkers = allEmployees.length;
                const totalLH = allEmployees.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0);
                const outPlan = dailyOutSettings[date]?.plan || parseInt(document.getElementById('out-plan').value) || 0;
                const inPlan = dailyInSettings[date]?.plan || parseInt(document.getElementById('in-plan').value) || 0;
                const nightPlan = dailyNightSettings[date]?.plan || parseInt(document.getElementById('night-plan').value) || 0;
                const totalRequiredLH = outStats.requiredLH + inStats.requiredLH + nightStats.requiredLH;
                const shortage = totalLH - totalRequiredLH;

                const employeesWithCategory = allEmployees.map(emp => {
                    const category = categorizeWorkStatus(emp.dailyStatuses[date], emp.timeSlot);
                    const printName = emp.company === emp.name ? '' : emp.name;
                    const shiftType = getShiftType(emp.timeSlot);
                    return { ...emp, category: category, printName: printName, shiftType: shiftType };
                }).sort((a, b) => {
                    // æ—¥å‹¤ã‚’å…ˆã«ã€å¤œå‹¤ã‚’å¾Œã«ã‚½ãƒ¼ãƒˆ
                    if (a.shiftType === 'æ—¥å‹¤' && b.shiftType === 'å¤œå‹¤') return -1;
                    if (a.shiftType === 'å¤œå‹¤' && b.shiftType === 'æ—¥å‹¤') return 1;
                    return 0;
                });
                
                multiPrintContent += `
                    <div class="print-day-container print-multi-day" ${index === 0 ? 'style="page-break-before: auto;"' : ''}>
                        <div class="print-header">
                            <div class="print-title">${date} æ—¥å‹¤ã‚·ãƒ•ãƒˆè¡¨</div>
                            <div style="font-size: 12px;">å‡ºé€€å‹¤ç¢ºèªè¡¨</div>
                        </div>

                        <div class="print-stats">
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">å‡ºå‹¤HC</div>
                                <div>${totalWorkers}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">å‡ºå‹¤LH</div>
                                <div>${totalLH.toFixed(2)}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">OUT PLAN</div>
                                <div>${outPlan.toLocaleString()}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">IN PLAN</div>
                                <div>${inPlan.toLocaleString()}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">å¤œå‹¤ PLAN</div>
                                <div>${nightPlan.toLocaleString()}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold;">å¿…è¦LH</div>
                                <div>${totalRequiredLH.toFixed(2)}</div>
                            </div>
                            <div class="print-stat-item">
                                <div style="font-weight: bold; color: ${shortage < 0 ? '#dc2626' : '#059669'};">éä¸è¶³</div>
                                <div style="color: ${shortage < 0 ? '#dc2626' : '#059669'};">${shortage > 0 ? '+' : ''}${shortage.toFixed(2)}</div>
                            </div>
                        </div>

                        <table class="print-table">
                            <caption class="print-table-caption">${date} å‹¤å‹™è€…ä¸€è¦§ (${totalWorkers}å)</caption>
                            <thead>
                                <tr>
                                    <th style="width: 8%;">æ™‚é–“å¸¯</th>
                                    <th style="width: 16%;">ä¼šç¤¾å</th>
                                    <th style="width: 13%;">ãƒ¡ã‚¤ãƒ³æ¥­å‹™</th>
                                    <th style="width: 13%;">æ°å</th>
                                    <th style="width: 7%;">é–‹å§‹æ™‚é–“</th>
                                    <th style="width: 7%;">çµ‚äº†æ™‚é–“</th>
                                    <th style="width: 6%;">ä¼‘æ†©</th>
                                    <th style="width: 10%;">è‡ªå·±ç”³å‘Š<br>ä½“èª¿</th>
                                    <th style="width: 10%;">ç†±ä¸­ç—‡<br>å¯¾ç­–ç¢ºèª</th>
                                    <th style="width: 10%;">å‚™è€ƒ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employeesWithCategory.map(emp => `
                                    <tr>
                                        <td style="text-align: center; font-size: 8px; font-weight: bold; color: ${emp.shiftType === 'å¤œå‹¤' ? '#7c3aed' : '#374151'};">${emp.shiftType}</td>
                                        <td style="text-align: center;">${emp.company}</td>
                                        <td style="text-align: center;">${emp.baseAssignment}</td>
                                        <td style="font-weight: bold; text-align: center;">${emp.printName}</td>
                                        <td style="text-align: center;">:</td>
                                        <td style="text-align: center;">:</td>
                                        <td style="text-align: center;">:</td>
                                        <td style="text-align: center;"></td>
                                        <td style="text-align: center;"></td>
                                        <td style="text-align: center;"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="print-footer">
                            <div>è²¬ä»»è€…ç¢ºèªï¼š_________________</div>
                            <div>æ—¥ä»˜ï¼š_______________ (${index + 1}/${dateRange.length})</div>
                        </div>
                    </div>
                `;
            });

            const printContent = document.getElementById('print-content');
            printContent.innerHTML = multiPrintContent;
            
            document.getElementById('print-preview').style.display = 'block';
            
            document.getElementById('print-preview').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });

            debugLog(`âœ… è¤‡æ•°æ—¥æœ€é©åŒ–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆå®Œäº†: ${dateRange.length}æ—¥åˆ†`, 'info');
        };

        // è¤‡æ•°æ—¥å°åˆ·å®Ÿè¡Œï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        window.generateMultiPrintSheet = function() {
            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            debugLog('ğŸ–¨ï¸ è¤‡æ•°æ—¥æœ€é©åŒ–å°åˆ·ã‚’å®Ÿè¡Œä¸­...', 'info');
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
            window.showMultiPrintPreview();

            // å°åˆ·å®Ÿè¡Œ
            setTimeout(() => {
                window.print();
                debugLog('ğŸ“„ è¤‡æ•°æ—¥æœ€é©åŒ–å°åˆ·å‡¦ç†å®Œäº†', 'info');
            }, 500);
        };

        // ãƒ‡ãƒãƒƒã‚°ç¯„å›²çŠ¶æ…‹ç¢ºèª
        window.debugRangeStatus = function() {
            debugLog('ğŸ” ç¯„å›²çŠ¶æ…‹ç¢ºèªã‚’å®Ÿè¡Œä¸­...', 'info');
            
            const status = {
                'startDateå¤‰æ•°': startDate || 'null',
                'endDateå¤‰æ•°': endDate || 'null',
                'é–‹å§‹æ—¥è¡¨ç¤º': document.getElementById('start-date-text')?.textContent || 'N/A',
                'çµ‚äº†æ—¥è¡¨ç¤º': document.getElementById('end-date-text')?.textContent || 'N/A',
                'ç¯„å›²æƒ…å ±è¡¨ç¤º': document.getElementById('range-info')?.style.display || 'N/A',
                'dateColumnsæ•°': dateColumns.length,
                'employeesæ•°': employees.length,
                'å°åˆ·æœ€é©åŒ–': 'æœ‰åŠ¹'
            };

            let message = 'ğŸ“Š ç¾åœ¨ã®ç¯„å›²çŠ¶æ…‹:\n\n';
            Object.entries(status).forEach(([key, value]) => {
                message += `${key}: ${value}\n`;
                debugLog(`${key}: ${value}`, 'info');
            });

            if (startDate && endDate) {
                try {
                    const dateRange = getDateRange(startDate, endDate);
                    message += `\nğŸ“… å¯¾è±¡æœŸé–“: ${dateRange.length}æ—¥\n`;
                    message += `å¯¾è±¡æ—¥ä»˜: ${dateRange.join(', ')}\n`;
                    debugLog(`å¯¾è±¡æœŸé–“: ${dateRange.length}æ—¥`, 'info');
                } catch (error) {
                    message += `\nâŒ ç¯„å›²è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
                    debugLog(`ç¯„å›²è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }

            message += '\nğŸ–¨ï¸ å°åˆ·æœ€é©åŒ–çŠ¶æ³:\n';
            message += 'âœ… è¡Œæ•°å¯¾å¿œå°åˆ·: æœ‰åŠ¹\n';
            message += 'âœ… ç©ºç™½ãƒšãƒ¼ã‚¸æ’é™¤: æœ‰åŠ¹\n';
            message += 'âœ… æ–‡å­—ã‚µã‚¤ã‚ºå›ºå®š: æœ‰åŠ¹\n';

            alert(message);
        };

        function updateLoadingStatus(message, progress = null, details = null) {
            const messageEl = document.getElementById('loading-message');
            const progressEl = document.getElementById('loading-progress');
            const detailsEl = document.getElementById('loading-details');
            
            if (messageEl) messageEl.textContent = message;
            if (progressEl && progress !== null) progressEl.style.width = progress + '%';
            if (detailsEl && details !== null) {
                detailsEl.textContent += (detailsEl.textContent ? '\n' : '') + details;
                detailsEl.scrollTop = detailsEl.scrollHeight;
            }
            
            debugLog(`ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: ${message}${details ? ' - ' + details : ''}`, 'info');
        }

        async function loadShiftData(file) {
            showScreen('loading');
            
            const detailsEl = document.getElementById('loading-details');
            if (detailsEl) detailsEl.textContent = '';
            
            try {
                updateLoadingStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 10, `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`);
                
                const arrayBuffer = await file.arrayBuffer();
                updateLoadingStatus('Excelãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’è§£æä¸­...', 20, `ArrayBufferä½œæˆå®Œäº†: ${arrayBuffer.byteLength} bytes`);
                
                const workbook = XLSX.read(arrayBuffer, {
                    cellStyles: true,
                    cellFormulas: false,
                    cellDates: true,
                    cellNF: false,
                    sheetStubs: false
                });
                
                updateLoadingStatus('ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªä¸­...', 30, `åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆ: ${workbook.SheetNames.join(', ')}`);

                let worksheet = null;
                let sheetName = '';
                
                if (workbook.Sheets['æ—¥å‹¤']) {
                    worksheet = workbook.Sheets['æ—¥å‹¤'];
                    sheetName = 'æ—¥å‹¤';
                } else if (workbook.SheetNames.length > 0) {
                    sheetName = workbook.SheetNames[0];
                    worksheet = workbook.Sheets[sheetName];
                }

                if (!worksheet) {
                    throw new Error('èª­ã¿è¾¼ã¿å¯èƒ½ãªãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                updateLoadingStatus('ã‚·ãƒ¼ãƒˆæ§‹é€ ã‚’è§£æä¸­...', 40, `ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒˆ: ${sheetName}`);

                if (!worksheet['!ref']) {
                    throw new Error('ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆãŒç©ºã§ã™');
                }
                
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                updateLoadingStatus('ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã‚’ç¢ºèªä¸­...', 50, `ã‚·ãƒ¼ãƒˆç¯„å›²: ${range.e.r + 1}è¡Œ Ã— ${range.e.c + 1}åˆ—`);
                
                debugLog(`ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${range.e.r + 1}è¡Œ Ã— ${range.e.c + 1}åˆ—`, 'info');

                // æ—¥ä»˜åˆ—ã®åé›†
                dateColumns = [];
                updateLoadingStatus('æ—¥ä»˜åˆ—ã‚’æ¤œç´¢ä¸­...', 60);
                
                let dateCount = 0;
                for (let col = 10; col <= range.e.c && col < 100; col++) {
                    try {
                        const cellAddress = XLSX.utils.encode_cell({r: 4, c: col});
                        const cell = worksheet[cellAddress];
                        
                        if (cell && cell.v && cell.v instanceof Date) {
                            const date = new Date(cell.v);
                            
                            if (!isNaN(date.getTime())) {
                                const dateString = date.toLocaleDateString('ja-JP');
                                dateColumns.push({
                                    col: col,
                                    date: date,
                                    dateString: dateString
                                });
                                dateCount++;
                            }
                        }
                    } catch (error) {
                        continue;
                    }
                }
                
                if (dateColumns.length === 0) {
                    throw new Error('æ—¥ä»˜åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚5è¡Œç›®ï¼ˆKåˆ—ä»¥é™ï¼‰ã«æœ‰åŠ¹ãªæ—¥ä»˜ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
                updateLoadingStatus('è¨­å®šå€¤ã‚’èª­ã¿è¾¼ã¿ä¸­...', 70, `æ¤œå‡ºã•ã‚ŒãŸæ—¥ä»˜: ${dateColumns.length}æ—¥åˆ†`);

                // PLAN/UPHè¨­å®šã®èª­ã¿è¾¼ã¿
                dailyOutSettings = {};
                dailyInSettings = {};
                dailyNightSettings = {};
                
                dateColumns.forEach(dateCol => {
                    try {
                        const getNumericCellValue = (row, col, defaultValue) => {
                            try {
                                const cell = worksheet[XLSX.utils.encode_cell({r: row, c: col})];
                                if (cell && typeof cell.v === 'number' && !isNaN(cell.v)) {
                                    return cell.v;
                                }
                                return defaultValue;
                            } catch {
                                return defaultValue;
                            }
                        };
                        
                        dailyOutSettings[dateCol.dateString] = {
                            plan: getNumericCellValue(0, dateCol.col, 20000),
                            uph: getNumericCellValue(1, dateCol.col, 60)
                        };
                        
                        dailyInSettings[dateCol.dateString] = {
                            plan: getNumericCellValue(2, dateCol.col, 20000),
                            uph: getNumericCellValue(3, dateCol.col, 90)
                        };
                        
                        dailyNightSettings[dateCol.dateString] = {
                            plan: 3000,
                            uph: 45
                        };
                    } catch (error) {
                        dailyOutSettings[dateCol.dateString] = { plan: 20000, uph: 60 };
                        dailyInSettings[dateCol.dateString] = { plan: 20000, uph: 90 };
                        dailyNightSettings[dateCol.dateString] = { plan: 3000, uph: 45 };
                    }
                });

                // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                employees = [];
                updateLoadingStatus('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 80);
                
                let processedCount = 0;
                
                for (let row = 5; row <= range.e.r; row++) {
                    try {
                        const getCellValue = (r, c, defaultValue = '') => {
                            try {
                                const cell = worksheet[XLSX.utils.encode_cell({r: r, c: c})];
                                return cell?.v || defaultValue;
                            } catch {
                                return defaultValue;
                            }
                        };
                        
                        const name = getCellValue(row, 3);
                        
                        if (name && typeof name === 'string' && name.trim() !== '') {
                            const timeSlot = String(getCellValue(row, 0));
                            const baseAssignment = String(getCellValue(row, 1));
                            const company = String(getCellValue(row, 2));
                            const startTime = String(getCellValue(row, 6));
                            const endTime = String(getCellValue(row, 7));
                            
                            const breakTimeRaw = getCellValue(row, 8);
                            const workHoursRaw = getCellValue(row, 9);
                            const breakTime = (typeof breakTimeRaw === 'number') ? breakTimeRaw : 0;
                            const workHours = (typeof workHoursRaw === 'number') ? workHoursRaw : 0;

                            let dailyStatuses = {};
                            for (let dateCol of dateColumns) {
                                try {
                                    const status = getCellValue(row, dateCol.col);
                                    dailyStatuses[dateCol.dateString] = String(status);
                                } catch {
                                    dailyStatuses[dateCol.dateString] = '';
                                }
                            }

                            employees.push({
                                rowNumber: row + 1,
                                timeSlot: timeSlot,
                                baseAssignment: baseAssignment,
                                company: company,
                                name: name.trim(),
                                startTime: startTime,
                                endTime: endTime,
                                breakTime: breakTime,
                                workHours: workHours,
                                dailyStatuses: dailyStatuses
                            });
                            
                            processedCount++;
                        }
                    } catch (error) {
                        debugLog(`è¡Œ ${row + 1} ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'warning');
                        continue;
                    }
                }
                
                if (employees.length === 0) {
                    throw new Error('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚6è¡Œç›®ä»¥é™ã®Dåˆ—ï¼ˆåå‰ï¼‰ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                updateLoadingStatus('ç”»é¢ã‚’åˆæœŸåŒ–ä¸­...', 90);

                try {
                    initMainScreen();
                    updateFileStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆæœ€é©åŒ–å°åˆ·å¯¾å¿œï¼‰', 'success');
                    updateLoadingStatus('èª­ã¿è¾¼ã¿å®Œäº†ï¼', 100, 'åˆ†æç”»é¢ã«ç§»å‹•ã—ã¦ã„ã¾ã™...');
                    
                    debugLog(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${employees.length}å, ${dateColumns.length}æ—¥åˆ† (æœ€é©åŒ–å°åˆ·å¯¾å¿œ)`, 'info');
                    
                    setTimeout(() => {
                        showScreen('main');
                    }, 500);
                } catch (initError) {
                    debugLog(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ï¼ˆãƒªã‚«ãƒãƒªè©¦è¡Œï¼‰: ${initError.message}`, 'error');
                    
                    try {
                        if (dateColumns.length > 0) {
                            currentMonth = new Date(dateColumns[0].date);
                            currentDate = dateColumns[0].dateString;
                        }
                        
                        updateFileStatus('éƒ¨åˆ†çš„èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆä¸€éƒ¨æ©Ÿèƒ½åˆ¶é™ï¼‰', 'warning');
                        updateLoadingStatus('éƒ¨åˆ†å®Œäº†', 95, 'ã„ãã¤ã‹ã®æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                        
                        setTimeout(() => {
                            showScreen('main');
                            
                            setTimeout(() => {
                                try {
                                    debugLog('ğŸ”„ é…å»¶åˆæœŸåŒ–ã‚’è©¦è¡Œä¸­...', 'info');
                                    if (typeof updateDateDisplay === 'function') updateDateDisplay();
                                    if (typeof updateAnalysis === 'function') updateAnalysis();
                                    debugLog('âœ… é…å»¶åˆæœŸåŒ–æˆåŠŸ', 'info');
                                } catch (delayedError) {
                                    debugLog(`âŒ é…å»¶åˆæœŸåŒ–å¤±æ•—: ${delayedError.message}`, 'error');
                                }
                            }, 1000);
                        }, 500);
                    } catch (recoveryError) {
                        debugLog(`âŒ ãƒªã‚«ãƒãƒªã‚‚å¤±æ•—: ${recoveryError.message}`, 'error');
                        throw initError;
                    }
                }
                
            } catch (error) {
                debugLog(`âŒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                
                let errorMessage = `ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:\n\n${error.message}`;
                
                if (error.message.includes('ç¯„å›²ãŒä¸æ­£') || error.message.includes('ç©ºã§ã™')) {
                    errorMessage += '\n\næ¨å¥¨å¯¾å‡¦æ³•:\nãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\nãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ä¿å­˜ã—ç›´ã—ã¦ã¿ã‚‹';
                } else if (error.message.includes('æ—¥ä»˜åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
                    errorMessage += '\n\næ¨å¥¨å¯¾å‡¦æ³•:\nãƒ»5è¡Œç›®ã®Kåˆ—ä»¥é™ã«æ—¥ä»˜ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\nãƒ»æ—¥ä»˜ãŒExcelã®æ—¥ä»˜å½¢å¼ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª';
                } else if (error.message.includes('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
                    errorMessage += '\n\næ¨å¥¨å¯¾å‡¦æ³•:\nãƒ»6è¡Œç›®ä»¥é™ã®Dåˆ—ã«å¾“æ¥­å“¡åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\nãƒ»åå‰ã‚»ãƒ«ãŒç©ºç™½ã§ãªã„ã‹ç¢ºèª';
                } else {
                    errorMessage += '\n\næ¨å¥¨å¯¾å‡¦æ³•:\nãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ãªã„ã‹ç¢ºèª\nãƒ»Excelã§é–‹ã‘ã‚‹ã‹ç¢ºèª\nãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ¥åä¿å­˜ã—ã¦ã‹ã‚‰å†è©¦è¡Œ';
                }
                
                updateLoadingStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 0, `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`);
                updateFileStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                
                setTimeout(() => {
                    alert(errorMessage);
                    showScreen('upload');
                }, 1000);
            }
        }

        function showScreen(screenName) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.add('hidden');
            
            document.getElementById(screenName + '-screen').classList.remove('hidden');
            
            debugLog(`ç”»é¢åˆ‡ã‚Šæ›¿ãˆ: ${screenName}`, 'info');
        }

        function initMainScreen() {
            try {
                debugLog('ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’åˆæœŸåŒ–ä¸­...ï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰', 'info');
                
                if (currentFile && currentFile.name) {
                    const filenameEl = document.getElementById('current-filename');
                    if (filenameEl) {
                        filenameEl.textContent = currentFile.name;
                    }
                }
                
                if (dateColumns.length > 0) {
                    // å½“æ—¥ã®æ—¥ä»˜ã‚’å„ªå…ˆã—ã¦é¸æŠ
                    const today = new Date().toLocaleDateString('ja-JP');
                    const todayColumn = dateColumns.find(col => col.dateString === today);
                    
                    if (todayColumn) {
                        currentDate = today;
                        currentMonth = new Date(todayColumn.date);
                        debugLog(`å½“æ—¥ã®æ—¥ä»˜ã‚’é¸æŠ: ${currentDate}`, 'info');
                    } else {
                        // å½“æ—¥ãŒãªã„å ´åˆã¯æœ€åˆã®æ—¥ä»˜ã‚’é¸æŠ
                        currentMonth = new Date(dateColumns[0].date);
                        currentDate = dateColumns[0].dateString;
                        debugLog(`å½“æ—¥ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚æœ€åˆã®æ—¥ä»˜ã‚’é¸æŠ: ${currentDate}`, 'info');
                    }
                }
                
                initCalendar();
                
                const elements = {
                    'date-selector-btn': showCalendarPopup,
                    'start-date-selector-btn': () => {
                        try {
                            showCalendarPopupForRange('start');
                        } catch (e) {
                            debugLog(`âŒ é–‹å§‹æ—¥é¸æŠã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'end-date-selector-btn': () => {
                        try {
                            showCalendarPopupForRange('end');
                        } catch (e) {
                            debugLog(`âŒ çµ‚äº†æ—¥é¸æŠã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'calendar-close': hideCalendarPopup,
                    'prev-month': () => {
                        currentMonth.setMonth(currentMonth.getMonth() - 1);
                        updateCalendar();
                    },
                    'next-month': () => {
                        currentMonth.setMonth(currentMonth.getMonth() + 1);
                        updateCalendar();
                    },
                    'out-plan': updateAnalysis,
                    'out-uph': updateAnalysis,
                    'in-plan': updateAnalysis,
                    'in-uph': updateAnalysis,
                    'night-plan': updateAnalysis,
                    'night-uph': updateAnalysis,
                    'print-button': () => {
                        try {
                            if (typeof generatePrintSheet === 'function') {
                                generatePrintSheet();
                            } else {
                                debugLog('âŒ generatePrintSheeté–¢æ•°ãŒæœªå®šç¾©', 'error');
                            }
                        } catch (e) {
                            debugLog(`âŒ å°åˆ·ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'print-preview-button': () => {
                        try {
                            if (typeof showPrintPreview === 'function') {
                                showPrintPreview();
                            } else {
                                debugLog('âŒ showPrintPreviewé–¢æ•°ãŒæœªå®šç¾©', 'error');
                            }
                        } catch (e) {
                            debugLog(`âŒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'multi-print-button': () => {
                        try {
                            if (typeof generateMultiPrintSheet === 'function') {
                                generateMultiPrintSheet();
                            } else {
                                debugLog('âŒ generateMultiPrintSheeté–¢æ•°ãŒæœªå®šç¾©', 'error');
                                alert('è¤‡æ•°æ—¥å°åˆ·æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                            }
                        } catch (e) {
                            debugLog(`âŒ è¤‡æ•°æ—¥å°åˆ·ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'multi-preview-button': () => {
                        try {
                            if (typeof showMultiPrintPreview === 'function') {
                                showMultiPrintPreview();
                            } else {
                                debugLog('âŒ showMultiPrintPreviewé–¢æ•°ãŒæœªå®šç¾©', 'error');
                                alert('è¤‡æ•°æ—¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                            }
                        } catch (e) {
                            debugLog(`âŒ è¤‡æ•°æ—¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'debug-range-button': () => {
                        try {
                            if (typeof debugRangeStatus === 'function') {
                                debugRangeStatus();
                            } else {
                                debugLog('âŒ debugRangeStatusé–¢æ•°ãŒæœªå®šç¾©', 'error');
                            }
                        } catch (e) {
                            debugLog(`âŒ ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
                        }
                    },
                    'force-reset-btn': forceReset,
                    'toggle-debug-btn': toggleDebug
                };
                
                Object.keys(elements).forEach(id => {
                    try {
                        const element = document.getElementById(id);
                        if (element) {
                            const handler = elements[id];
                            
                            const newElement = element.cloneNode(true);
                            element.parentNode.replaceChild(newElement, element);
                            
                            const refreshedElement = document.getElementById(id);
                            if (refreshedElement) {
                                if (id.includes('plan') || id.includes('uph')) {
                                    refreshedElement.addEventListener('input', handler);
                                    debugLog(`ğŸ“ inputã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š: ${id}`, 'info');
                                } else {
                                    refreshedElement.addEventListener('click', (e) => {
                                        try {
                                            debugLog(`ğŸ–±ï¸ ${id} ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º`, 'info');
                                            handler(e);
                                        } catch (error) {
                                            debugLog(`âŒ ${id} ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                                        }
                                    });
                                    debugLog(`ğŸ–±ï¸ clickã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š: ${id}`, 'info');
                                }
                            }
                        } else {
                            debugLog('âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + id, 'error');
                        }
                    } catch (error) {
                        debugLog('âŒ ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼ (' + id + '): ' + error.message, 'error');
                    }
                });
                
                const calendarPopup = document.getElementById('calendar-popup');
                if (calendarPopup) {
                    calendarPopup.addEventListener('click', (e) => {
                        if (e.target.id === 'calendar-popup') {
                            hideCalendarPopup();
                        }
                    });
                }

                updateDateDisplay();
                updateRangeDateDisplay();
                updateDateSettings();
                updateAnalysis();
                
                debugLog('âœ… ãƒ¡ã‚¤ãƒ³ç”»é¢åˆæœŸåŒ–å®Œäº†ï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰', 'info');
            } catch (error) {
                debugLog(`âŒ ãƒ¡ã‚¤ãƒ³ç”»é¢åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                throw error;
            }
        }

        function showCalendarPopup() {
            dateSelectionMode = 'single';
            document.getElementById('calendar-popup').classList.add('show');
            updateCalendar();
        }

        function showCalendarPopupForRange(type) {
            dateSelectionMode = type;
            document.getElementById('calendar-popup').classList.add('show');
            updateCalendar();
            debugLog(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º: ${type}æ—¥é¸æŠãƒ¢ãƒ¼ãƒ‰`, 'info');
        }

        function hideCalendarPopup() {
            document.getElementById('calendar-popup').classList.remove('show');
            dateSelectionMode = 'single';
        }

        function updateDateDisplay() {
            const dateText = currentDate || 'æ—¥ä»˜ã‚’é¸æŠ';
            document.getElementById('selected-date-text').textContent = dateText;
            
            const btn = document.getElementById('date-selector-btn');
            if (currentDate) {
                btn.classList.add('selected');
            } else {
                btn.classList.remove('selected');
            }
        }

        function updateRangeDateDisplay() {
            var startDateText = startDate || 'é–‹å§‹æ—¥ã‚’é¸æŠ';
            var endDateText = endDate || 'çµ‚äº†æ—¥ã‚’é¸æŠ';
            
            debugLog('ğŸ” ç¯„å›²è¡¨ç¤ºæ›´æ–°: startDate="' + startDate + '", endDate="' + endDate + '"', 'info');
            
            document.getElementById('start-date-text').textContent = startDateText;
            document.getElementById('end-date-text').textContent = endDateText;
            
            if (startDate && endDate) {
                try {
                    var dateRange = getDateRange(startDate, endDate);
                    var rangeInfo = document.getElementById('range-info');
                    var rangeSummary = document.getElementById('range-summary');
                    var pageCount = document.getElementById('page-count');
                    
                    debugLog('ğŸ“Š ç¯„å›²è¨ˆç®—çµæœ: ' + dateRange.length + 'æ—¥åˆ†', 'info');
                    
                    if (rangeSummary && pageCount && rangeInfo) {
                        rangeSummary.textContent = startDate + ' ï½ ' + endDate + ' (' + dateRange.length + 'æ—¥)';
                        pageCount.textContent = dateRange.length;
                        rangeInfo.style.display = 'block';
                        
                        debugLog('âœ… ç¯„å›²æƒ…å ±è¡¨ç¤ºå®Œäº†: ' + startDate + ' ï½ ' + endDate + ' (' + dateRange.length + 'æ—¥)', 'info');
                    } else {
                        debugLog('âŒ ç¯„å›²æƒ…å ±è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                } catch (error) {
                    debugLog('âŒ ç¯„å›²è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            } else {
                var rangeInfo = document.getElementById('range-info');
                if (rangeInfo) {
                    rangeInfo.style.display = 'none';
                }
                debugLog('âšª ç¯„å›²æƒ…å ±éè¡¨ç¤ºï¼ˆæ—¥ä»˜æœªé¸æŠï¼‰', 'info');
            }
        }

        function initCalendar() {
            updateCalendar();
        }

        function updateCalendar() {
            const calendarTitle = document.getElementById('calendar-title');
            const calendarGrid = document.getElementById('calendar-grid');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            calendarTitle.textContent = `${year}å¹´${month + 1}æœˆ`;
            
            calendarGrid.innerHTML = '';
            
            const dayHeaders = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.fontWeight = '600';
                dayHeader.style.color = '#6b7280';
                dayHeader.style.padding = '8px 4px';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.fontSize = '12px';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                const dateString = date.toLocaleDateString('ja-JP');
                const dayOfWeek = date.getDay();
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else if (dayOfWeek === 0) {
                    dayElement.classList.add('weekend');
                } else if (dayOfWeek === 6) {
                    dayElement.classList.add('saturday');
                }
                
                const hasData = dateColumns.some(col => col.dateString === dateString);
                if (hasData) {
                    dayElement.style.cursor = 'pointer';
                    dayElement.addEventListener('click', () => {
                        if (dateSelectionMode === 'single') {
                            selectDate(dateString);
                        } else if (dateSelectionMode === 'start') {
                            selectStartDate(dateString);
                        } else if (dateSelectionMode === 'end') {
                            selectEndDate(dateString);
                        }
                    });
                    
                    if (dateSelectionMode === 'single' && dateString === currentDate) {
                        dayElement.classList.add('selected');
                    } else if (dateSelectionMode === 'start' && dateString === startDate) {
                        dayElement.classList.add('selected');
                    } else if (dateSelectionMode === 'end' && dateString === endDate) {
                        dayElement.classList.add('selected');
                    }
                } else {
                    dayElement.style.opacity = '0.3';
                    dayElement.style.cursor = 'not-allowed';
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function selectDate(dateString) {
            currentDate = dateString;
            updateCalendar();
            updateDateDisplay();
            updateDateSettings();
            updateAnalysis();
            hideCalendarPopup();
            
            debugLog(`æ—¥ä»˜é¸æŠ: ${dateString}`, 'info');
        }

        function selectStartDate(dateString) {
            startDate = dateString;
            debugLog('ğŸ“… é–‹å§‹æ—¥é¸æŠ: ' + dateString, 'info');
            updateCalendar();
            updateRangeDateDisplay();
            hideCalendarPopup();
        }

        function selectEndDate(dateString) {
            endDate = dateString;
            debugLog('ğŸ“… çµ‚äº†æ—¥é¸æŠ: ' + dateString, 'info');
            updateCalendar();
            updateRangeDateDisplay();
            hideCalendarPopup();
        }

        function updateDateSettings() {
            if (currentDate && dailyOutSettings[currentDate] && dailyInSettings[currentDate]) {
                // å¯¾è±¡æ—¥ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¨­å®šå€¤ã‚’è¡¨ç¤º
                document.getElementById('out-plan').value = dailyOutSettings[currentDate].plan;
                document.getElementById('out-uph').value = dailyOutSettings[currentDate].uph;
                document.getElementById('in-plan').value = dailyInSettings[currentDate].plan;
                document.getElementById('in-uph').value = dailyInSettings[currentDate].uph;
                
                debugLog(`è¨­å®šæ›´æ–°: OUT(${dailyOutSettings[currentDate].plan}/${dailyOutSettings[currentDate].uph}) IN(${dailyInSettings[currentDate].plan}/${dailyInSettings[currentDate].uph})`, 'info');
            } else {
                // å¯¾è±¡æ—¥ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºç™½
                document.getElementById('out-plan').value = '';
                document.getElementById('out-uph').value = '';
                document.getElementById('in-plan').value = '';
                document.getElementById('in-uph').value = '';
                
                debugLog(`è¨­å®šã‚¯ãƒªã‚¢: å¯¾è±¡æ—¥ ${currentDate} ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`, 'info');
            }
            
            // å¤œå‹¤è¨­å®šã¯ç¾çŠ¶ã®ã¾ã¾ç¶­æŒ
            if (currentDate && dailyNightSettings[currentDate]) {
                document.getElementById('night-plan').value = dailyNightSettings[currentDate].plan;
                document.getElementById('night-uph').value = dailyNightSettings[currentDate].uph;
            }
        }

        function updateAnalysis() {
            if (!currentDate) return;

            debugLog(`åˆ†ææ›´æ–°: ${currentDate}`, 'info');

            const outEmployees = getWorkingEmployees(currentDate, 'OUT');
            const outStats = calculateStats(outEmployees, 'out');
            updateStatsDisplay('out', outStats);
            updateEmployeeList('out', outEmployees);

            const inEmployees = getWorkingEmployees(currentDate, 'IN');
            const inStats = calculateStats(inEmployees, 'in');
            updateStatsDisplay('in', inStats);
            updateEmployeeList('in', inEmployees);

            const nightEmployees = getNightShiftEmployees(currentDate);
            const nightStats = calculateStats(nightEmployees, 'night');
            updateStatsDisplay('night', nightStats);
            updateEmployeeList('night', nightEmployees);
        }

        function getWorkingEmployees(date, type) {
            return employees.filter(emp => {
                const status = emp.dailyStatuses[date];
                if (!status || status === 'ä¼‘' || status === 'æœ‰ä¼‘' || status === '') {
                    return false;
                }
                
                const category = categorizeWorkStatus(status, emp.timeSlot);
                return category === type;
            });
        }

        function getNightShiftEmployees(date) {
            return employees.filter(emp => {
                const status = emp.dailyStatuses[date];
                if (!status || status === 'ä¼‘' || status === 'æœ‰ä¼‘' || status === '') {
                    return false;
                }
                
                return isNightShift(emp.timeSlot);
            });
        }

        function getAllWorkingEmployees(date) {
            return employees.filter(emp => {
                const status = emp.dailyStatuses[date];
                return status && status !== 'ä¼‘' && status !== 'æœ‰ä¼‘' && status !== '';
            });
        }

        function calculateStats(workingEmps, type) {
            const plan = parseInt(document.getElementById(`${type}-plan`).value) || 0;
            const uph = parseInt(document.getElementById(`${type}-uph`).value) || 0;
            
            const totalLH = workingEmps.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0);
            const requiredLH = totalLH > 0 && uph > 0 ? plan / uph : 0;
            const shortage = totalLH - requiredLH;
            
            return {
                workerCount: workingEmps.length,
                actualLH: totalLH,
                requiredLH: requiredLH,
                shortage: shortage,
                plan: plan,
                uph: uph
            };
        }

        function updateStatsDisplay(type, stats) {
            document.getElementById(`${type}-worker-count`).textContent = stats.workerCount;
            document.getElementById(`${type}-actual-lh`).textContent = stats.actualLH.toFixed(1);
            document.getElementById(`${type}-required-lh`).textContent = stats.requiredLH.toFixed(1);
            
            const shortageLhElement = document.getElementById(`${type}-shortage-lh`);
            const shortageValue = stats.shortage;
            
            if (shortageValue > 0) {
                shortageLhElement.textContent = '+' + shortageValue.toFixed(1);
                shortageLhElement.className = 'stat-value stat-green';
            } else if (shortageValue < 0) {
                shortageLhElement.textContent = shortageValue.toFixed(1);
                shortageLhElement.className = 'stat-value stat-red';
            } else {
                shortageLhElement.textContent = '0.0';
                shortageLhElement.className = 'stat-value stat-blue';
            }

            updateShortageAlert(type, shortageValue);
        }

        function updateShortageAlert(type, shortage) {
            // ææ¡ˆéƒ¨åˆ†ã‚’å‰Šé™¤ - ã‚¢ãƒ©ãƒ¼ãƒˆã¯è¡¨ç¤ºã—ãªã„
            const alertContainer = document.getElementById(`${type}-shortage-alert`);
            if (alertContainer) {
                alertContainer.innerHTML = '';
            }
        }

        function updateEmployeeList(type, workingEmployees) {
            const container = document.getElementById(`${type}-employee-list`);
            
            if (workingEmployees.length === 0) {
                const typeDisplayMap = {
                    'out': 'OUT',
                    'in': 'IN',
                    'night': 'å¤œå‹¤'
                };
                container.innerHTML = `
                    <div style="text-align: center; padding: 32px; color: #6b7280;">
                        ${typeDisplayMap[type] || type.toUpperCase()}å‹¤å‹™è€…ã¯ã„ã¾ã›ã‚“
                    </div>
                `;
                return;
            }
            
            const typeDisplayMap = {
                'out': 'OUT',
                'in': 'IN',
                'night': 'å¤œå‹¤'
            };
            
            container.innerHTML = `
                <div class="status-header">
                    <div class="status-title">${typeDisplayMap[type] || type.toUpperCase()} å‹¤å‹™è€… (${workingEmployees.length}å)</div>
                    <div class="status-info">
                        ç·åŠ´åƒæ™‚é–“: ${workingEmployees.reduce((sum, emp) => sum + (parseFloat(emp.workHours) || 0), 0).toFixed(1)}h
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>åå‰</th>
                                <th>åŸºæœ¬é…ç½®</th>
                                <th>æ™‚é–“å¸¯</th>
                                <th>å‹¤å‹™æ™‚é–“</th>
                                <th>åŠ´åƒæ™‚é–“</th>
                                <th>ä¼šç¤¾</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${workingEmployees.map(emp => `
                                <tr>
                                    <td style="font-weight: 500;">
                                        ${emp.name}
                                        <span style="font-size: 10px; color: #6b7280; margin-left: 4px;">(${emp.rowNumber || '?'}è¡Œç›®)</span>
                                    </td>
                                    <td>${emp.baseAssignment}</td>
                                    <td style="color: ${type === 'night' ? '#7c3aed' : '#6b7280'}; font-weight: 500;">${emp.timeSlot}</td>
                                    <td>
                                        ${emp.startTime}-${emp.endTime}
                                        ${emp.breakTime > 0 ? `<span style="font-size: 12px; color: #6b7280;"> (ä¼‘æ†©${emp.breakTime}h)</span>` : ''}
                                    </td>
                                    <td>${emp.workHours}h</td>
                                    <td style="color: #6b7280;">${emp.company}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // å®Œå…¨ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function forceReset() {
            debugLog('ğŸ”„ å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œä¸­...', 'warning');
            
            if (employees.length > 0) {
                debugLog(`ğŸ“Š ãƒªã‚»ãƒƒãƒˆå‰ã®çµ±è¨ˆ: å¾“æ¥­å“¡${employees.length}å, æ—¥ä»˜${dateColumns.length}æ—¥åˆ†`, 'info');
            }
            
            employees = [];
            dateColumns = [];
            dailyOutSettings = {};
            dailyInSettings = {};
            dailyNightSettings = {};
            currentDate = null;
            currentFile = null;
            fileHash = null;
            startDate = null;
            endDate = null;
            dateSelectionMode = 'single';
            
            const elementsToReset = [
                'current-filename', 'selected-date-text', 'start-date-text', 'end-date-text',
                'out-worker-count', 'out-actual-lh', 'out-required-lh', 'out-shortage-lh',
                'in-worker-count', 'in-actual-lh', 'in-required-lh', 'in-shortage-lh',
                'night-worker-count', 'night-actual-lh', 'night-required-lh', 'night-shortage-lh',
                'out-employee-list', 'in-employee-list', 'night-employee-list', 'print-preview'
            ];
            
            elementsToReset.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.tagName === 'INPUT') {
                        el.value = '';
                    } else {
                        el.textContent = '';
                        el.innerHTML = '';
                    }
                }
            });
            
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.value = '';
            });
            
            document.getElementById('out-plan').value = '';
            document.getElementById('out-uph').value = '';
            document.getElementById('in-plan').value = '';
            document.getElementById('in-uph').value = '';
            document.getElementById('night-plan').value = 3000;
            document.getElementById('night-uph').value = 45;
            
            document.getElementById('range-info').style.display = 'none';
            document.getElementById('start-date-text').textContent = 'é–‹å§‹æ—¥ã‚’é¸æŠ';
            document.getElementById('end-date-text').textContent = 'çµ‚äº†æ—¥ã‚’é¸æŠ';
            
            updateFileStatus('ãƒªã‚»ãƒƒãƒˆå®Œäº†', 'warning');
            debugLog('âœ… å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆå®Œäº†', 'info');
            showScreen('upload');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹æ›´æ–°
        function updateFileStatus(message, status = 'success') {
            const statusEl = document.getElementById('file-status');
            const textEl = document.getElementById('file-status-text');
            const timestampEl = document.getElementById('file-timestamp');
            const indicator = statusEl.querySelector('.status-indicator');
            
            if (textEl) textEl.textContent = message;
            if (timestampEl) timestampEl.textContent = new Date().toLocaleString();
            
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanels = document.querySelectorAll('.debug-panel');
            debugPanels.forEach(panel => {
                panel.style.display = debugMode ? 'block' : 'none';
            });
            
            const btn = document.getElementById('toggle-debug-btn');
            if (btn) {
                btn.textContent = debugMode ? 'ğŸ› ãƒ‡ãƒãƒƒã‚°éè¡¨ç¤º' : 'ğŸ› ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º';
            }
            
            debugLog(`ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${debugMode ? 'ON' : 'OFF'}`, 'info');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã®åˆæœŸåŒ–
        function initFileUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const newFileInput = document.getElementById('new-file-input');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);

            fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            newFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        }

        async function handleFileSelect(file) {
            if (!file) return;
            
            debugLog(`ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`, 'info');
            
            const fileName = file.name.toLowerCase();
            const validExtensions = ['.xlsx', '.xls'];
            const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!hasValidExtension) {
                const errorMsg = `å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚\n\nå¯¾å¿œå½¢å¼: ${validExtensions.join(', ')}\né¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`;
                debugLog(errorMsg, 'error');
                alert(errorMsg);
                return;
            }

            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                const errorMsg = `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚\n\næœ€å¤§ã‚µã‚¤ã‚º: 50MB\nãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(1)}MB`;
                debugLog(errorMsg, 'error');
                alert(errorMsg);
                return;
            }

            const newHash = await generateFileHash(file);
            if (fileHash && fileHash === newHash) {
                debugLog('âš ï¸ åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚', 'warning');
                forceReset();
                setTimeout(() => handleFileSelect(file), 100);
                return;
            }

            fileHash = newHash;
            currentFile = file;
            debugLog(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚·ãƒ¥: ${fileHash}`, 'info');
            
            employees = [];
            dateColumns = [];
            dailyOutSettings = {};
            dailyInSettings = {};
            currentDate = null;
            
            loadShiftData(file);
        }

        // å¤œå‹¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        function isNightShift(timeSlot) {
            if (!timeSlot) return false;
            
            const timeSlotStr = timeSlot.toString().toUpperCase();
            
            // å¤œå‹¤åˆ¤å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            const nightKeywords = [
                'å¤œå‹¤', 'NIGHT', 'Nå‹¤', 'Bå‹¤', 'å¤œ', 'ãƒŠã‚¤ãƒˆ',
                '22:', '23:', '0:', '1:', '2:', '3:', '4:', '5:',
                '22æ™‚', '23æ™‚', '0æ™‚', '1æ™‚', '2æ™‚', '3æ™‚', '4æ™‚', '5æ™‚'
            ];
            
            return nightKeywords.some(keyword => timeSlotStr.includes(keyword));
        }

        // å‹¤å‹™çŠ¶æ…‹åˆ†é¡ï¼ˆå¤œå‹¤å¯¾å¿œç‰ˆï¼‰
        const outTasks = [
            'Pack', 'FL', 'Bulk', 'Ship', 'Shipping', 
            'Out_Fork', 'Out_Indirect', 'OUTQA', 'Out',
            'Outbound', 'Loading', 'Dock'
        ];
        const inTasks = [
            'ICQA', 'Hi', 'Pick', 'pick', 'IN', 'Receive',
            'Read', 'Receiving', 'Inbound', 'Stow',
            'Problem', 'Quality'
        ];
        
        function categorizeWorkStatus(status, timeSlot = null) {
            if (!status || status === 'ä¼‘' || status === 'æœ‰ä¼‘' || status === '' || status === 'æ¬ å‹¤') {
                return null;
            }
            
            // å¤œå‹¤åˆ¤å®šã‚’æœ€å„ªå…ˆ
            if (timeSlot && isNightShift(timeSlot)) {
                return 'NIGHT';
            }
            
            const statusStr = status.toString();
            const statusUpper = statusStr.toUpperCase();
            
            for (let outTask of outTasks) {
                if (statusUpper.includes(outTask.toUpperCase())) {
                    return 'OUT';
                }
            }
            
            for (let inTask of inTasks) {
                if (statusUpper.includes(inTask.toUpperCase())) {
                    return 'IN';
                }
            }
            
            switch (statusUpper) {
                case 'P': case 'PACK': case 'PACKING':
                    return 'OUT';
                case 'I': case 'ICQA': case 'IB': case 'INBOUND':
                    return 'IN';
                case 'F': case 'FL': case 'FLOOR':
                    return 'OUT';
                case 'H': case 'HI': case 'PICK': case 'PICKING':
                    return 'IN';
                case 'R': case 'READ': case 'READING':
                    return 'IN';
                case 'S': case 'SHIP': case 'SHIPPING':
                    return 'OUT';
                case 'B': case 'BULK':
                    return 'OUT';
                default:
                    return 'OUT';
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹ï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰', 'info');
            initFileUpload();
            debugLog('âœ… åˆæœŸåŒ–å®Œäº†ï¼ˆæœ€é©åŒ–å°åˆ·ç‰ˆï¼‰', 'info');
        });
    </script>
</body>
</html>
